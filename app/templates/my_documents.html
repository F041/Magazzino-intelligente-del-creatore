{% extends "base.html" %}

{% block title %}I tuoi documenti - Magazzino del Creatore{% endblock %}

{% block content %}
    <h1>I tuoi documenti caricati ({{ documents|length }})</h1>
    
    <div id="action-message"></div>

    <div id="documents-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Nome Originale</th>
                    <th>Data Caricamento</th>
                    <th>Stato</th>
                    <th>Dimensione (kB)</th>
                    <th>Azioni</th>
                </tr>
            </thead>
            <tbody>
                {% for doc in documents %}
                <tr id="doc-row-{{ doc.doc_id | escape }}">
                    <td>{{ doc.original_filename }}</td>
                    <td>{{ doc.uploaded_at | format_date('%d %b %Y %H:%M') }}</td>
                    <td>
                        <span class="status-badge status-{{ doc.processing_status | lower | replace('_', '-') }}">{{ doc.processing_status }}</span>
                    </td>
                    <td>
                        {# La dimensione ora viene dal DB. Se non c'è, mostriamo N/D #}
                        {% if doc.filesize %}
                            {{ "%.1f"|format(doc.filesize / 1024) }}
                        {% else %}
                            N/D
                        {% endif %}
                    </td>
                    <td>                                           
                        <button class="action-btn delete-btn" data-doc-id="{{ doc.doc_id }}">
                            Elimina
                        </button>
                        {# Il loader ora è nascosto di default e non ha testo #}
                        <span class="action-loader delete-loader" style="display: none;"><i class="fas fa-spinner fa-spin"></i></span>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5" class="no-items-message">
                        Nessun documento trovato nel database.<br>
                        Vai su <a href="{{ url_for('data_entry') }}">Ingresso Dati</a> per caricare documenti.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% endblock %}

{% block scripts %}
{{ super() }} {# Importante per avere la funzione showConfirmModal #}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const messageDiv = document.getElementById('action-message');

        // Funzione per mostrare notifiche in cima (già presente in base.html ma la ridefiniamo qui per sicurezza)
        function showNotification(message, type = "success") {
            if (!messageDiv) return;
            messageDiv.className = type === "success" ? "success-message" : "error-message";
            messageDiv.textContent = message;
            messageDiv.style.display = 'block';
            setTimeout(() => { if(messageDiv) messageDiv.style.display = 'none'; }, 5000);
        }

        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', async (event) => {
                const btn = event.currentTarget;
                const docId = btn.dataset.docId;
                const tableRow = btn.closest('tr');
                const loaderSpan = btn.nextElementSibling;
                const originalButtonHTML = btn.innerHTML;

                if (!docId || !tableRow) return;

                // --- NUOVA LOGICA CON MODALE PERSONALIZZATO ---
                const userConfirmed = await showConfirmModal(
                    "Conferma eliminazione",
                    `Sei sicuro di voler eliminare definitivamente il documento "${tableRow.cells[0].textContent.trim()}"? L'azione è irreversibile.`
                );
                
                if (!userConfirmed) {
                    return; // L'utente ha annullato
                }
                // --- FINE NUOVA LOGICA ---

                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; // Mostra lo spinner DENTRO il bottone
                if (loaderSpan) loaderSpan.style.display = 'none'; // Assicuriamoci che il vecchio loader sia nascosto

                try {
                    const response = await fetch(`/api/documents/${docId}`, { 
                        method: 'DELETE', 
                        headers: { 'Accept': 'application/json' } 
                    });
                    const data = await response.json();

                    if (response.ok && data.success) {
                        tableRow.remove();
                        showNotification(data.message || 'Documento eliminato con successo.', 'success');
                        
                        // Controlla se la tabella è vuota dopo l'eliminazione
                        const tbody = document.querySelector('#documents-container tbody');
                        if (tbody && tbody.children.length === 0) {
                            tbody.innerHTML = `<tr><td colspan="5" class="no-items-message">Nessun documento rimasto.</td></tr>`;
                        }
                    } else {
                        throw new Error(data.message || `Errore ${response.status}`);
                    }
                } catch (error) {
                    showNotification(`Errore eliminazione: ${error.message}`, 'error');
                    btn.disabled = false;
                    btn.innerHTML = originalButtonHTML; // Ripristina il testo originale
                }
            });
        });
    });
</script>
{% endblock %}