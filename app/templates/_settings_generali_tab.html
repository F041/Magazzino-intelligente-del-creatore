<div id="generali" class="tab-content">
    <div class="form-section">
        <h2><span>Intelligenza artificiale</span></h2>
        <div class="form-group">
            <label>Fornitore modello linguistico</label>
            <div class="custom-select-container">
                {# Questo input nascosto conterrà il valore reale ('google' o 'ollama') per il form #}
                <input
                    type="hidden"
                    id="llm_provider"
                    name="llm_provider"
                    value="{{ settings.get('llm_provider') or 'google' }}"
                />

                {# Questo è l'elemento visibile che mostra la selezione corrente #}
                <div class="select-selected">
                    {% if settings.get('llm_provider') == 'ollama' %}
                        {# --- HTML per OLLAMA --- #}
                        <div class="option-content">
                            <div class="option-main">
                                <img src="https://ollama.com/public/ollama.png" alt="Ollama logo" />
                                <span>Ollama (Locale)</span>
                            </div>
                            <div class="option-badges">
                                <span class="option-badge badge-cost">-Costi</span>
                                <span class="option-badge badge-privacy">+Riservatezza</span>
                                <span class="option-badge badge-difficulty">Difficile</span>
                            </div>
                        </div>
                    {% elif settings.get('llm_provider') == 'groq' %}
                        {# --- HTML per GROQ --- #}
                        <div class="option-content">
                            <div class="option-main">
                                <img src="https://pbs.twimg.com/profile_images/1758638326237495296/DNUq2D2c_400x400.jpg" alt="Groq logo" style="width: 1.2em; height: 1.2em; border-radius: 50%;">
                                <span>Groq</span>
                            </div>
                            <div class="option-badges">
                                <span class="option-badge badge-easy" style="background-color: #d4edda; color: #155724;">+Veloce</span>
                            </div>
                        </div>
                    {% else %}
                        {# --- HTML per GOOGLE (DEFAULT) --- #}
                        <div class="option-content">
                            <div class="option-main">
                                <i class="fab fa-google"></i>
                                <span>Google Gemini</span>
                            </div>
                            <div class="option-badges">
                                <span class="option-badge badge-easy">Facile</span>
                            </div>
                        </div>
                    {% endif %}
                </div>

                {# Questa è la lista delle opzioni, nascosta di default #}
                <div class="select-items select-hide">
                    
                    {# --- Opzione Google --- #}
                    <div data-value="google">
                        <div class="option-content">
                            <div class="option-main">
                                <i class="fab fa-google"></i>
                                <span>Google Gemini</span>
                            </div>
                            <div class="option-badges">
                                <span class="option-badge badge-easy">Facile</span>
                            </div>
                        </div>
                    </div>

                    {# --- Opzione Groq --- #}
                    <div data-value="groq">
                        <div class="option-content">
                            <div class="option-main">
                                <img
                                    src="https://groq.com/apple-touch-icon.png"
                                    alt="Groq logo"
                                    style="width: 1.2em; height: 1.2em; border-radius: 50%;"
                                />
                                <span>Groq</span>
                            </div>
                            <div class="option-badges">
                                <span class="option-badge badge-easy" style="background-color: #d4edda; color: #155724;">+Veloce</span>
                            </div>
                        </div>
                    </div>

                    {# --- Opzione Ollama --- #}
                    <div data-value="ollama">
                        <div class="option-content">
                            <div class="option-main">
                                <img
                                    src="https://ollama.com/public/ollama.png"
                                    alt="Ollama logo"
                                />
                                <span>Ollama (Locale)</span>
                            </div>
                            <div class="option-badges">
                                <span class="option-badge badge-cost">-Costi</span>
                                <span class="option-badge badge-privacy"
                                    >+Riservatezza</span
                                >
                                <span class="option-badge badge-difficulty">Difficile</span>
                            </div>
                        </div>
                    </div>
                
                </div>
            </div>
        </div>

        {# --- BLOCCO IMPOSTAZIONI GOOGLE --- #}
        <div
            id="google-settings-group"
            class="{% if settings.get('llm_provider') != 'ollama' %}visible{% else %}hidden{% endif %}"
        >
            <div class="form-group">
                <div class="label-wrapper">
                    <label for="llm_model_name_primary"
                        >Modello IA primario (per generazione)</label
                    >
                    <span class="info-tooltip warning-tooltip">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span class="tooltip-text"
                            ><strong>Modello consigliato:</strong> testato con
                            <code>gemini-2.5-pro</code> e <code>gemini-2.5-flash</code>.
                            Altri potrebbero funzionare.</span
                        >
                    </span>
                </div>
                <input
                    type="text"
                    id="llm_model_name_primary"
                    name="llm_model_name_primary"
                    value="{{ settings.get('llm_model_name_primary', '') }}"
                    placeholder="Consigliato: gemini-2.5-pro"
                />
            </div>

            <div class="form-group">
                <div class="label-wrapper">
                    <label for="llm_model_name_fallback"
                        >Modello di ripiego (opzionale)</label
                    >
                    <div class="tooltip-group">
                        <span class="info-tooltip">
                            <span class="fa-stack"
                                ><i class="fas fa-circle fa-stack-2x"></i
                                ><i class="fas fa-info fa-stack-1x fa-inverse"></i
                            ></span>
                            <span class="tooltip-text"
                                >Se il modello primario fallisce, l'applicazione proverà ad
                                usare questo.</span
                            >
                        </span>
                    </div>
                </div>
                <input
                    type="text"
                    id="llm_model_name_fallback"
                    name="llm_model_name_fallback"
                    value="{{ settings.get('llm_model_name_fallback', '') }}"
                    placeholder="Es: gemini-2.5-flash"
                />
            </div>

            <div class="form-group">
                <div class="label-wrapper">
                    <label for="llm_embedding_model"
                        >Modello per trasformare il testo in linguaggio macchina</label
                    >
                    <div class="tooltip-group">
                        <span class="info-tooltip">
                            <span class="fa-stack"
                                ><i class="fas fa-circle fa-stack-2x"></i
                                ><i class="fas fa-info fa-stack-1x fa-inverse"></i
                            ></span>
                            <span class="tooltip-text"
                                >Il "traduttore" che trasforma il testo in numeri per la
                                ricerca. Per Gemini,
                                <code>models/text-embedding-004</code> è una scelta
                                stabile- NON più a dicembre 2025.</span
                            >
                        </span>
                    </div>
                </div>
                <input
                    type="text"
                    id="llm_embedding_model"
                    name="llm_embedding_model"
                    value="{{ settings.get('llm_embedding_model') or '' }}"
                    placeholder="Default: models/gemini-embedding-001"
                    autocomplete="off"
                />
            </div>

            <div class="form-group">
                <div class="label-wrapper">
                    <label for="llm_api_key"
                        >Chiave per servizio modello linguistico</label
                    >
                    <div class="tooltip-group">
                        <span class="info-tooltip">
                            <span class="fa-stack">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fas fa-info fa-stack-1x fa-inverse"></i>
                            </span>
                            <span class="tooltip-text"
                                >La tua "password" per usare il servizio di Intelligenza
                                Artificiale scelto. Viene salvata in modo sicuro. Se lasci
                                vuoto, verrà usata quella di default del sistema.</span
                            >
                        </span>
                        <a
                            href="https://console.cloud.google.com/apis/credentials"
                            target="_blank"
                            class="help-video-link"
                            title="Guarda come trovare la tua API Key"
                        >
                            <i class="fab fa-youtube"></i>
                        </a>
                    </div>
                </div>
                <input type="password" id="llm_api_key" name="llm_api_key" value="{{ settings.get('llm_api_key') or '' }}" placeholder="Incolla la tua API Key qui" autocomplete="new-password" readonly>
            </div>
        </div>

        {# --- INIZIO BLOCCO IMPOSTAZIONI GROQ --- #}
        <div id="groq-settings-group" class="hidden">
            <div class="form-group">
                <div class="label-wrapper">
                    <label for="llm_model_name_primary">Modello IA primario (per generazione)</label>
                    <span class="info-tooltip warning-tooltip">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span class="tooltip-text"><strong>Caldamente consigliati:</strong> modelli SOPRA i 20 miliardi di paramentri <code>20b</code>, es <code>llama-3.3-70b-versatile</code>, <code>openai/gpt-oss-120b</code>, <code>qwen/qwen3-32b</code>. Controlla il sito di Groq per la lista completa.</span>
                    </span>
                </div>
                <input
                    type="text"
                    id="groq_model_name_primary"
                    name="llm_model_name_primary"
                    value="{{ settings.get('llm_model_name_primary', '') }}"
                    placeholder="Consigliato: openai/gpt-oss-120b"
                />
            </div>

            <div class="form-group">
                <div class="label-wrapper">
                    <label for="groq_model_name_fallback">Modello di ripiego (opzionale)</label>
                    {# --- TOOLTIP AGGIUNTO QUI --- #}
                    <div class="tooltip-group">
                        <span class="info-tooltip">
                            <span class="fa-stack">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fas fa-info fa-stack-1x fa-inverse"></i>
                            </span>
                            <span class="tooltip-text">
                                Se il modello primario fallisce, l'applicazione proverà ad usare questo.
                            </span>
                        </span>
                    </div>
                </div>
                
                <input
                    type="text"
                    id="groq_model_name_fallback"
                    name="llm_model_name_fallback"
                    value="{{ settings.get('llm_model_name_fallback', '') }}"
                    placeholder="openai/gpt-oss-20b"
                />
            </div>

            <div class="form-group">
                <div class="label-wrapper">
                    <label for="groq_api_key">Chiave API di Groq</label>
                                      <div class="tooltip-group">
                        <span class="info-tooltip">
                            <span class="fa-stack">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fas fa-info fa-stack-1x fa-inverse"></i>
                            </span>
                            <span class="tooltip-text">
                                La tua "password" per usare il servizio di Intelligenza Artificiale scelto. Viene salvata in modo sicuro.
                            </span>
                        </span>
                        <a
                            href="https://youtu.be/4dd4Xof9mS0?t=441"
                            target="_blank"
                            class="help-video-link"
                            title="Guarda come trovare la tua API Key di Groq"
                        >
                            <i class="fab fa-youtube"></i>
                        </a>
                    </div>
                </div>
                <input type="password" id="groq_api_key" name="llm_api_key" value="{{ settings.get('llm_api_key') or '' }}" placeholder="Incolla la tua API Key di Groq (gsk_...)" autocomplete="new-password" readonly>
            </div>
        </div>
        {# --- FINE BLOCCO IMPOSTAZIONI GROQ --- #}

        {# --- BLOCCO IMPOSTAZIONI OLLAMA (CON TOOLTIP AGGIUNTIVI) --- #}
        <div
            id="ollama-settings-group"
            class="{% if settings.get('llm_provider') == 'ollama' %}visible{% else %}hidden{% endif %}"
        >
            <div class="form-group">
                <div class="label-wrapper">
                    <label for="ollama_base_url">Indirizzo server Ollama</label>
                    <div class="tooltip-group">
                        <span class="info-tooltip docker-tooltip">
                            <i class="fab fa-docker"></i>
                            <span class="tooltip-text">
                                <strong>Nota per utenti Docker:</strong> Se Ollama è
                                installato sulla tua macchina (host) e non dentro Docker,
                                usa <code>http://host.docker.internal:11434</code>.
                            </span>
                        </span>
                        {# NUOVO TOOLTIP PER VPN/RETE LOCALE #}
                        <span class="info-tooltip network-tooltip">
                            <i class="fas fa-network-wired"></i>
                            <span class="tooltip-text">
                                <strong>Nota per VPN/Rete Locale:</strong> Se Ollama si
                                trova su un'altra macchina nella tua stessa rete, dovrai
                                usare l'indirizzo IP di quella macchina. Esempio:
                                <code>http://192.168.1.50:11434</code>.
                            </span>
                        </span>
                    </div>
                </div>
                <input
                    type="url"
                    id="ollama_base_url"
                    name="ollama_base_url"
                    value="{{ settings.get('ollama_base_url') or 'http://localhost:11434' }}"
                    placeholder="Es: http://localhost:11434"
                />
            </div>
            <div class="form-group">
                <div class="label-wrapper">
                    <label for="ollama_model_name"
                        >Nome modello Ollama (per generazione)</label
                    >
                    <div class="tooltip-group">
                        <span class="info-tooltip warning-tooltip">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span class="tooltip-text"
                                > Per risultati più simili ai modelli commerciali, si consiglia di
                                partire da modelli con ALMENO 8 miliardi di parametri (es.
                                <code>qwen3:8b</code>) o superiori (es.
                                <code>gpt-oss-20b</code>).</span
                            >
                        </span>

                        <a
                            href="https://ollama.com/library"
                            target="_blank"
                            class="help-video-link"
                            title="Sfoglia la libreria di modelli Ollama"
                            rel="noopener noreferrer"
                        >
                            <i class="fas fa-book-open"></i>
                        </a>
                    </div>
                </div>

                <input
                    type="text"
                    id="ollama_model_name"
                    name="ollama_model_name"
                    value="{{ settings.get('llm_model_name') or '' }}"
                    placeholder="Es: gemma3:8b, qwen3:1.7b"
                />
                <small
                    >Il nome esatto del modello che hai scaricato con
                    <code>ollama pull</code>. Su Windows, puoi vedere i modelli che
                    hai scaricato tramite Powershell digitando
                    <code>ollama ps</code>.</small
                >
            </div>

                        <div class="form-group">
                <div class="label-wrapper">
                    <label for="ollama_embedding_model">Modello per embedding (linguaggio macchina)</label>
                    <div class="tooltip-group">
                        <span class="info-tooltip">
                            <span class="fa-stack">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fas fa-info fa-stack-1x fa-inverse"></i>
                            </span>
                            <span class="tooltip-text">
                                Opzionale. Se lasciato vuoto, verrà usato il modello di Google <code>embeddinggemma-300m</code>. Se specificato, assicurati di averlo scaricato con <code>ollama pull nome_modello</code>.
                            </span>
                        </span>
                        <span class="info-tooltip warning-tooltip">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span class="tooltip-text">
                                <strong>Modelli consigliati:</strong> <code>embeddinggemma-300m</code> (molto leggero).
                            </span>
                        </span>
                    </div>
                </div>
            <input
                    type="text"
                    id="ollama_embedding_model"
                    name="ollama_embedding_model"
                    value="{{ settings.get('llm_embedding_model') or '' }}"
                    placeholder="Es: nomic-embed-text"
                />
            </div>

            <div style="margin-top: 15px">
                <button
                    type="button"
                    id="test-ollama-btn"
                    class="action-btn"
                    style="background: var(--color-text-light)"
                >
                    Testa connessione
                </button>
                <div id="ollama-test-result" style="margin-top: 10px"></div>
            </div>
        </div>
    </div>
</div>