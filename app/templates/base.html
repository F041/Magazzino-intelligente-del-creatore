<!-- FILE: app/templates/base.html (Versione con Layout Sidebar Robusto - CORRETTO) -->
<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}Magazzino del Creatore{% endblock %}</title>

    <link
      rel="icon"
      href="{{ url_for('static', filename='favicon.ico') }}"
      type="image/x-icon"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/styles.css') }}"
    />
    
    {% if personalization_settings.brand_color %}
    <style>
        :root {
            --color-primary: {{ personalization_settings.brand_color }};
        }
    </style>
    {% endif %}
    {# --- INIZIO BLOCCO FONT DINAMICO --- #}
    {% if personalization_settings.brand_font %}
        {# Carichiamo il font da Google Fonts solo se non è un font di sistema #}
        {% if 'Segoe UI' not in personalization_settings.brand_font and 'Courier New' not in personalization_settings.brand_font %}
            <link rel="preconnect" href="https://fonts.googleapis.com">
            <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
            <link href="https://fonts.googleapis.com/css2?family={{ personalization_settings.brand_font.split(',')[0].replace(' ', '+') }}:wght@400;700&display=swap" rel="stylesheet">
        {% endif %}

        {# Sovrascriviamo la variabile CSS per il font principale #}
        <style>
            :root {
                --font-sans: '{{ personalization_settings.brand_font.split(',')[0] }}', {{ personalization_settings.brand_font.split(',')[1] or 'sans-serif' }};
            }
        </style>
    {% endif %}
    {# --- FINE BLOCCO FONT DINAMICO --- #}

    {% block head_styles %}{% endblock %}
  </head>
  <body>
    <div class="sidebar sidebar‑metal">
      <!-- Intestazione della Sidebar (fissa) -->
      <div class="sidebar-header">
        <div class="sidebar-brand">
        {# Se l'utente ha impostato un URL per il logo, mostra l'immagine... #}
        {% if personalization_settings.brand_logo_url %}
        <img src="{{ personalization_settings.brand_logo_url }}" alt="Logo" style="height: 32px; max-width: 40px; border-radius: 4px; margin-right: 10px;">
        {# ...altrimenti, mostra l'icona di default. #}
        {% else %}
        <i class="fas fa-warehouse"></i>
        {% endif %}
        <span>Magazzino</span>
        </div>
      </div>

      <!-- CORREZIONE: Il menu principale ora è il contenitore che scrolla -->
      <ul class="sidebar-menu">
        <li class="{{ 'active' if request.endpoint == 'data_entry' else '' }}">
          <a href="{{ url_for('data_entry') }}"
            ><i class="fas fa-file-import fa-fw"></i
            ><span>Ingresso dati</span></a
          >
        </li>

        {% if content_counts.has_videos %}
        <li class="{{ 'active' if request.endpoint == 'my_videos' else '' }}">
          <a href="{{ url_for('my_videos') }}"
            ><i class="fas fa-video fa-fw"></i><span>I tuoi video</span></a
          >
        </li>
        {% endif %} {% if content_counts.has_documents %}
        <li
          class="{{ 'active' if request.endpoint == 'my_documents' else '' }}"
        >
          <a href="{{ url_for('my_documents') }}"
            ><i class="fas fa-file-alt fa-fw"></i
            ><span>I tuoi documenti</span></a
          >
        </li>
        {% endif %} 
        
        {# Blocco Articoli #}
        {% if content_counts.has_articles %}
        <li class="{{ 'active' if request.endpoint == 'my_articles' else '' }}">
          <a href="{{ url_for('my_articles') }}"
            ><i class="fas fa-newspaper fa-fw"></i
            ><span>I tuoi articoli</span></a
          >
        </li>
        {% endif %}
        
        {# Blocco Pagine (ora indipendente) #}
        {% if content_counts.has_pages %}
        <li class="{{ 'active' if request.endpoint == 'my_pages' else '' }}">
          <a href="{{ url_for('my_pages') }}"
            ><i class="fas fa-window-maximize"></i> <!-- Tolto fa-fw che non serve qui -->
            <span>Le tue pagine</span></a
          >
        </li>
        {% endif %}
     
        {% if content_counts.has_videos or
        content_counts.has_documents or content_counts.has_articles %}
        <li
          class="{{ 'active' if request.endpoint == 'automations_page' else '' }}"
        >
          <a href="{{ url_for('automations_page') }}"
            ><i class="fas fa-robot fa-fw"></i><span>Automazioni</span></a
          >
        </li>
        <li class="{{ 'active' if request.endpoint == 'chat_page' else '' }}">
          <a href="{{ url_for('chat_page') }}"
            ><i class="fas fa-comments fa-fw"></i><span>Chat</span></a
          >
        </li>
        <li
          class="{{ 'active' if request.endpoint == 'keys.manage_api_keys_page' else '' }}"
        >
          <a href="{{ url_for('keys.manage_api_keys_page') }}"
            ><i class="fas fa-key fa-fw"></i><span>Chiavi API</span></a
          >
        </li>
        <li
          class="{{ 'active' if request.endpoint == 'generate_link_page' else '' }}"
        >
          <a href="{{ url_for('generate_link_page') }}"
            ><i class="fas fa-share-alt fa-fw"></i><span>Accesso terzi</span></a
          >
        </li>
        {% endif %}
      </ul>

      <!-- Footer della Sidebar (fisso) -->
      <div class="sidebar-footer">
        <ul class="sidebar-menu">
          {% if content_counts.has_videos or content_counts.has_documents or content_counts.has_articles or content_counts.has_pages %}
          <li class="{{ 'active' if request.endpoint == 'statistics.statistics_page' else '' }}">
            <a href="{{ url_for('statistics.statistics_page') }}">
              <i class="fas fa-chart-bar fa-fw"></i>
              <span>STATistiche</span>
            </a>
          </li>
          {% endif %}

          <li class="{{ 'active' if request.endpoint == 'personalization_page' else '' }}">
            <a href="{{ url_for('personalization_page') }}">
              <i class="fas fa-paint-brush fa-fw"></i>
              <span>Personalizzazione</span>
            </a>
          </li>
          <li
            class="{{ 'active' if request.endpoint == 'settings.settings_page' else '' }}"
          >
            <a href="{{ url_for('settings.settings_page') }}">
              <i class="fas fa-cog fa-fw"></i>
              <span>Impostazioni</span>
            </a>
          </li>
          <li
            class="{{ 'active' if request.endpoint == 'system_status_page' else '' }}"
          >
            <a href="{{ url_for('system_status_page') }}">
              <i class="fas fa-microchip fa-fw"></i>
              <span>Stato del sistema</span>
            </a>
          </li>
        </ul>
        <hr />
        <ul class="sidebar-menu">
          <li>
            <a href="{{ url_for('logout') }}">
              <i class="fas fa-sign-out-alt fa-fw"></i>
              <span>Logout</span>
            </a>
          </li>
        </ul>
      </div>
    </div>

    <main class="main-content">{% block content %}{% endblock %}</main>

    <!-- Modale di Conferma Globale -->
    <div id="confirm-modal-overlay" class="modal-overlay"></div>
    <div id="confirm-modal" class="modal-box">
      <h3 id="confirm-modal-title">Conferma azione</h3>
      <p id="confirm-modal-text">Sei sicuro di voler procedere?</p>
      <div class="modal-buttons">
        <button id="confirm-modal-cancel" class="action-btn secondary">
          Annulla
        </button>
        <button id="confirm-modal-ok" class="action-btn">Conferma</button>
      </div>
    </div>

    <!-- ===== BLOCCO SCRIPT UNIFICATO E CORRETTO ===== -->
    {% block scripts %}
    <script>
      // --- FUNZIONE GLOBALE PER MODALE DI CONFERMA ---
      function showConfirmModal(title, text) {
        const confirmModal = document.getElementById("confirm-modal");
        const confirmOverlay = document.getElementById("confirm-modal-overlay");
        const confirmOkBtn = document.getElementById("confirm-modal-ok");
        const confirmCancelBtn = document.getElementById("confirm-modal-cancel");
        const confirmTitle = document.getElementById("confirm-modal-title");
        const confirmText = document.getElementById("confirm-modal-text");

        return new Promise((resolve) => {
          if (!confirmModal || !confirmOverlay || !confirmOkBtn || !confirmCancelBtn) {
            console.error("Elementi del modale di conferma non trovati!");
            resolve(window.confirm(text));
            return;
          }
          confirmTitle.textContent = title;
          confirmText.textContent = text;
          confirmModal.classList.add("visible");
          confirmOverlay.classList.add("visible");

          const onOk = () => { closeModal(); resolve(true); };
          const onCancel = () => { closeModal(); resolve(false); };

          const closeModal = () => {
            confirmModal.classList.remove("visible");
            confirmOverlay.classList.remove("visible");
            confirmOkBtn.removeEventListener("click", onOk);
            confirmCancelBtn.removeEventListener("click", onCancel);
            confirmOverlay.removeEventListener("click", onCancel);
          };

          confirmOkBtn.addEventListener("click", onOk, { once: true });
          confirmCancelBtn.addEventListener("click", onCancel, { once: true });
          confirmOverlay.addEventListener("click", onCancel, { once: true });
        });
      }

      // --- FUNZIONE GLOBALE PER FAVICON DINAMICA (robusta, con cache-busting) ---
      (function () {
        const selector = "link[rel~='icon']";
        const faviconNodes = Array.from(document.head.querySelectorAll(selector));
        const originalHref = faviconNodes.length ? faviconNodes[0].href : null;

        const loadingFavicon = (function () {
          const canvas = document.createElement("canvas");
          canvas.width = 32; canvas.height = 32;
          const ctx = canvas.getContext("2d");
          ctx.beginPath(); ctx.arc(16, 16, 14, 0, 2 * Math.PI, false);
          ctx.fillStyle = "#ced4da"; ctx.fill();
          ctx.beginPath(); ctx.arc(24, 24, 6, 0, 2 * Math.PI, false);
          ctx.fillStyle = "#4361ee"; ctx.fill();
          ctx.strokeStyle = "white"; ctx.lineWidth = 2; ctx.stroke();
          return canvas.toDataURL("image/png");
        })();

        function setHrefOnAll(href) {
          const nodes = Array.from(document.head.querySelectorAll(selector));
          if (nodes.length === 0) {
            const link = document.createElement('link');
            link.rel = 'icon';
            link.type = 'image/x-icon';
            link.href = href || '';
            document.head.appendChild(link);
            return;
          }
          nodes.forEach(n => {
            try {
              n.href = href || '';
            } catch (e) {
              const newLink = document.createElement('link');
              newLink.rel = 'icon';
              newLink.type = n.type || 'image/x-icon';
              newLink.href = href || '';
              n.parentNode.replaceChild(newLink, n);
            }
          });
        }

        window.setAppStatus = function (status) {
          if (status === "processing") {
            setHrefOnAll(loadingFavicon);
          } else {
            if (originalHref) {
              const base = originalHref.split('?')[0];
              setHrefOnAll(base + '?v=' + Date.now());
            } else {
              setHrefOnAll('');
            }
          }
        };
      })();

      // --- LOGICA GLOBALE PER PROCESSI ASINCRONI (POLLING) ---
      (function() {
        let pollingInterval = null;
        let timerInterval = null;
        let secondsElapsed = 0;

        function startTimer(container) {
            stopTimer();
            secondsElapsed = 0;

            // assicurati che esista un elemento .timer (viene aggiunto qui se manca)
            let timerElement = container.querySelector('.timer');
            if (!timerElement) {
                timerElement = document.createElement('span');
                timerElement.className = 'timer';
                timerElement.style.marginLeft = '15px';
                timerElement.style.fontStyle = 'italic';
                container.appendChild(timerElement);
            }

            timerInterval = setInterval(() => {
                secondsElapsed++;
                // ogni tick cerchiamo l'elemento corrente: resiliente alle ricostruzioni DOM
                const elem = container.querySelector('.timer');
                if (elem) {
                    elem.textContent = `(${secondsElapsed}s)`;
                }
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
        }

        // Utility per svuotare e resettare un nodo DOM in modo pulito
        function clearElement(el) {
            while (el.firstChild) el.removeChild(el.firstChild);
            el.className = '';
        }

        async function checkProgress(endpoint, uiElements) {
            try {
                const response = await fetch(endpoint);
                const data = await response.json();

                const msgDiv = uiElements.messageDiv;
                if (!msgDiv) return;

                if (!data.is_processing) {
                    if (pollingInterval) { clearInterval(pollingInterval); pollingInterval = null; }
                    stopTimer();

                    if (uiElements.button) {
                        uiElements.button.disabled = false;
                        uiElements.button.innerHTML = uiElements.buttonOriginalHTML || uiElements.button.innerHTML;
                    }
                    if (uiElements.loader) uiElements.loader.style.display = 'none';

                    // costruzione del messaggio finale senza innerHTML
                    clearElement(msgDiv);
                    msgDiv.className = data.error ? 'error-message' : 'success-message';

                    const messageSpan = document.createElement('span');
                    messageSpan.textContent = data.error || data.message || 'Operazione completata.';
                    msgDiv.appendChild(messageSpan);

                    if (!data.error) {
                        const container = document.createElement('div');
                        container.className = 'progress-bar-container';
                        container.style.marginTop = '8px';
                        container.style.height = '8px';
                        container.style.backgroundColor = 'var(--progress-bg, #e9ecef)';
                        container.style.borderRadius = '4px';
                        container.style.overflow = 'hidden';

                        const bar = document.createElement('div');
                        bar.className = 'progress-bar';
                        bar.style.width = '100%';
                        bar.style.height = '100%';
                        bar.style.background = 'var(--gradient-primary)';
                        bar.style.transition = 'width 0.3s ease';
                        container.appendChild(bar);
                        msgDiv.appendChild(container);
                    }

                    // RIPRISTINA FAVICON
                    if (typeof window.setAppStatus === 'function') window.setAppStatus('ready');
                    if (uiElements.onSuccess && typeof uiElements.onSuccess === 'function') {
                    uiElements.onSuccess();
                }
                
                } else {
                    // processo in corso: aggiorniamo lo stato senza innerHTML
                    clearElement(msgDiv);
                    msgDiv.className = 'info-message';

                    // Messaggio principale
                    const messageSpan = document.createElement('span');
                    messageSpan.textContent = data.message || 'Elaborazione in corso...';
                    msgDiv.appendChild(messageSpan);

                    // progress bar
                    let progressPercent = 0;
                    if (data.total_items > 0) {
                        progressPercent = Math.round((data.processed_items / data.total_items) * 100);
                    }

                    const container = document.createElement('div');
                    container.className = 'progress-bar-container';
                    container.style.marginTop = '8px';
                    container.style.height = '8px';
                    container.style.backgroundColor = 'var(--progress-bg, #e9ecef)';
                    container.style.borderRadius = '4px';
                    container.style.overflow = 'hidden';

                    const bar = document.createElement('div');
                    bar.className = 'progress-bar';
                    bar.style.width = `${progressPercent}%`;
                    bar.style.height = '100%';
                    bar.style.background = 'var(--gradient-primary)';
                    bar.style.transition = 'width 0.3s ease';
                    container.appendChild(bar);
                    msgDiv.appendChild(container);

                    // Aggiungiamo una linea di testo percentuale (facoltativa)
                    const percentSpan = document.createElement('div');
                    percentSpan.className = 'progress-text';
                    percentSpan.style.marginTop = '6px';
                    percentSpan.style.fontSize = '0.9em';
                    percentSpan.style.opacity = '0.9';
                    percentSpan.textContent = `${progressPercent}% (${data.processed_items || 0}/${data.total_items || 0})`;
                    msgDiv.appendChild(percentSpan);

                    // Aggiungiamo il timer dentro il messageSpan se non c'è
                    if (!msgDiv.querySelector('.timer')) {
                        let timerElement = document.createElement('span');
                        timerElement.className = 'timer';
                        timerElement.style.marginLeft = '15px';
                        timerElement.style.fontStyle = 'italic';
                        messageSpan.appendChild(timerElement);
                    }

                    // Assicuriamoci che la favicon sia in stato processing
                    if (typeof window.setAppStatus === 'function') window.setAppStatus('processing');
                }
            } catch (error) {
                if (pollingInterval) { clearInterval(pollingInterval); pollingInterval = null; }
                stopTimer();
                if (uiElements.button) uiElements.button.disabled = false;
                if (uiElements.loader) uiElements.loader.style.display = 'none';

                const msgDiv = uiElements.messageDiv;
                if (msgDiv) {
                    clearElement(msgDiv);
                    msgDiv.className = 'error-message';
                    const strong = document.createElement('strong');
                    strong.textContent = 'Errore: ';
                    msgDiv.appendChild(strong);
                    const txt = document.createElement('span');
                    txt.textContent = 'Errore di connessione durante il controllo dello stato.';
                    msgDiv.appendChild(txt);
                }

                // RIPRISTINA FAVICON anche in caso di errore
                if (typeof window.setAppStatus === 'function') window.setAppStatus('ready');
            }
        }

        // Esponiamo una funzione globale per essere chiamata dalle altre pagine
        window.startAsyncTask = function(endpoint, uiElements) {
            if (pollingInterval) clearInterval(pollingInterval);

            if (uiElements.button) {
                uiElements.button.disabled = true;
                uiElements.buttonOriginalHTML = uiElements.buttonOriginalHTML || uiElements.button.innerHTML;
            }
            if (uiElements.loader) uiElements.loader.style.display = 'inline';
            if (uiElements.messageDiv) {
                // reset message area in modo sicuro
                clearElement(uiElements.messageDiv);
                uiElements.messageDiv.className = 'info-message';
                const starting = document.createElement('span');
                starting.textContent = 'Avvio operazione...';
                uiElements.messageDiv.appendChild(starting);
            }

            // Avvia il cronometro sulla messageDiv (resiliente)
            if (uiElements.messageDiv) startTimer(uiElements.messageDiv);

            // Chiamiamo subito una volta, poi ogni 2s
            checkProgress(endpoint, uiElements);
            pollingInterval = setInterval(() => checkProgress(endpoint, uiElements), 2000);

            // Imposta favicon in stato processing
            if (typeof window.setAppStatus === 'function') {
                window.setAppStatus('processing');
            }
        }
      })();
    </script>
    {% endblock %}
  </body>
</html>
