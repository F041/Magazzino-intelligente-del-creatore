<!-- FILE: app/templates/base.html (Versione con Layout Sidebar Robusto) -->
<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}Magazzino del Creatore{% endblock %}</title>

    <link
      rel="icon"
      href="{{ url_for('static', filename='favicon.ico') }}"
      type="image/x-icon"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/styles.css') }}"
    />
    {% block head_styles %}{% endblock %}
  </head>
  <body>
    <div class="sidebar">
      <!-- Intestazione della Sidebar (fissa) -->
      <div class="sidebar-header">
        <div class="sidebar-brand">
          <i class="fas fa-warehouse"></i>
          <span>Magazzino</span>
        </div>
      </div>

      <!-- CORREZIONE: Il menu principale ora è il contenitore che scrolla -->
      <ul class="sidebar-menu">
        <li class="{{ 'active' if request.endpoint == 'data_entry' else '' }}">
          <a href="{{ url_for('data_entry') }}"
            ><i class="fas fa-file-import fa-fw"></i
            ><span>Ingresso dati</span></a
          >
        </li>

        {% if content_counts.has_videos %}
        <li class="{{ 'active' if request.endpoint == 'my_videos' else '' }}">
          <a href="{{ url_for('my_videos') }}"
            ><i class="fas fa-video fa-fw"></i><span>I tuoi video</span></a
          >
        </li>
        {% endif %} {% if content_counts.has_documents %}
        <li
          class="{{ 'active' if request.endpoint == 'my_documents' else '' }}"
        >
          <a href="{{ url_for('my_documents') }}"
            ><i class="fas fa-file-alt fa-fw"></i
            ><span>I tuoi documenti</span></a
          >
        </li>
        {% endif %} {% if content_counts.has_articles %}
        <li class="{{ 'active' if request.endpoint == 'my_articles' else '' }}">
          <a href="{{ url_for('my_articles') }}"
            ><i class="fas fa-newspaper fa-fw"></i
            ><span>I tuoi articoli</span></a
          >
        </li>
        {% endif %} {% if content_counts.has_videos or
        content_counts.has_documents or content_counts.has_articles %}
        <li
          class="{{ 'active' if request.endpoint == 'automations_page' else '' }}"
        >
          <a href="{{ url_for('automations_page') }}"
            ><i class="fas fa-robot fa-fw"></i><span>Automazioni</span></a
          >
        </li>
        <li class="{{ 'active' if request.endpoint == 'chat_page' else '' }}">
          <a href="{{ url_for('chat_page') }}"
            ><i class="fas fa-comments fa-fw"></i><span>Chat</span></a
          >
        </li>
        <li
          class="{{ 'active' if request.endpoint == 'keys.manage_api_keys_page' else '' }}"
        >
          <a href="{{ url_for('keys.manage_api_keys_page') }}"
            ><i class="fas fa-key fa-fw"></i><span>Chiavi API</span></a
          >
        </li>
        <li
          class="{{ 'active' if request.endpoint == 'generate_link_page' else '' }}"
        >
          <a href="{{ url_for('generate_link_page') }}"
            ><i class="fas fa-share-alt fa-fw"></i><span>Accesso terzi</span></a
          >
        </li>
        {% endif %}
      </ul>

      <!-- Footer della Sidebar (fisso) -->
      <div class="sidebar-footer">
        <ul class="sidebar-menu">
          <li
            class="{{ 'active' if request.endpoint == 'settings.settings_page' else '' }}"
          >
            <a href="{{ url_for('settings.settings_page') }}">
              <i class="fas fa-cog fa-fw"></i>
              <span>Impostazioni</span>
            </a>
          </li>
        </ul>
        <hr />
        <ul class="sidebar-menu">
          <li>
            <a href="{{ url_for('logout') }}">
              <i class="fas fa-sign-out-alt fa-fw"></i>
              <span>Logout</span>
            </a>
          </li>
        </ul>
      </div>
    </div>

    <main class="main-content">{% block content %}{% endblock %}</main>

    <!-- Modale di Conferma Globale -->
    <div id="confirm-modal-overlay" class="modal-overlay"></div>
    <div id="confirm-modal" class="modal-box">
      <h3 id="confirm-modal-title">Conferma azione</h3>
      <p id="confirm-modal-text">Sei sicuro di voler procedere?</p>
      <div class="modal-buttons">
        <button id="confirm-modal-cancel" class="action-btn secondary">
          Annulla
        </button>
        <button id="confirm-modal-ok" class="action-btn">Conferma</button>
      </div>
    </div>

    <!-- ===== BLOCCO SCRIPT UNIFICATO E CORRETTO ===== -->
    {% block scripts %}
    <script>
      // --- FUNZIONE GLOBALE PER MODALE DI CONFERMA ---
      function showConfirmModal(title, text) {
        const confirmModal = document.getElementById("confirm-modal");
        const confirmOverlay = document.getElementById("confirm-modal-overlay");
        const confirmOkBtn = document.getElementById("confirm-modal-ok");
        const confirmCancelBtn = document.getElementById("confirm-modal-cancel");
        const confirmTitle = document.getElementById("confirm-modal-title");
        const confirmText = document.getElementById("confirm-modal-text");

        return new Promise((resolve) => {
          if (!confirmModal || !confirmOverlay || !confirmOkBtn || !confirmCancelBtn) {
            console.error("Elementi del modale di conferma non trovati!");
            resolve(window.confirm(text));
            return;
          }
          confirmTitle.textContent = title;
          confirmText.textContent = text;
          confirmModal.classList.add("visible");
          confirmOverlay.classList.add("visible");

          const onOk = () => { closeModal(); resolve(true); };
          const onCancel = () => { closeModal(); resolve(false); };

          const closeModal = () => {
            confirmModal.classList.remove("visible");
            confirmOverlay.classList.remove("visible");
            confirmOkBtn.removeEventListener("click", onOk);
            confirmCancelBtn.removeEventListener("click", onCancel);
            confirmOverlay.removeEventListener("click", onCancel);
          };

          confirmOkBtn.addEventListener("click", onOk, { once: true });
          confirmCancelBtn.addEventListener("click", onCancel, { once: true });
          confirmOverlay.addEventListener("click", onCancel, { once: true });
        });
      }

      // --- FUNZIONE GLOBALE PER FAVICON DINAMICA ---
      (function () {
        const originalFavicon = document.querySelector("link[rel='icon']").href;
        const loadingFavicon = (function () {
          const canvas = document.createElement("canvas");
          canvas.width = 32; canvas.height = 32;
          const ctx = canvas.getContext("2d");
          ctx.beginPath(); ctx.arc(16, 16, 14, 0, 2 * Math.PI, false);
          ctx.fillStyle = "#ced4da"; ctx.fill();
          ctx.beginPath(); ctx.arc(24, 24, 6, 0, 2 * Math.PI, false);
          ctx.fillStyle = "#4361ee"; ctx.fill();
          ctx.strokeStyle = "white"; ctx.lineWidth = 2; ctx.stroke();
          return canvas.toDataURL("image/png");
        })();
        window.setAppStatus = function (status) {
          const faviconElement = document.querySelector("link[rel='icon']");
          if (!faviconElement) return;
          faviconElement.href = status === "processing" ? loadingFavicon : originalFavicon;
        };
      })();

      // --- LOGICA GLOBALE PER PROCESSI ASINCRONI (POLLING) ---
      (function() {
        let pollingInterval = null;
        let timerInterval = null;
        let secondsElapsed = 0;

        function startTimer(container) {
            stopTimer();
            secondsElapsed = 0;
            let timerElement = container.querySelector('.timer');
            if (!timerElement) {
                timerElement = document.createElement('span');
                timerElement.className = 'timer';
                timerElement.style.marginLeft = '15px';
                timerElement.style.fontStyle = 'italic';
                container.appendChild(timerElement);
            }
            timerInterval = setInterval(() => {
                secondsElapsed++;
                timerElement.textContent = `(${secondsElapsed}s)`;
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
        }
        
            async function checkProgress(endpoint, uiElements) {
                try {
                    const response = await fetch(endpoint);
                    const data = await response.json();

                    if (!data.is_processing) {
                        clearInterval(pollingInterval);
                        pollingInterval = null;
                        stopTimer(); // <-- FERMA IL CRONOMETRO QUI, ALLA FINE
                        if (uiElements.button) {
                           uiElements.button.disabled = false;
                           uiElements.button.innerHTML = uiElements.buttonOriginalHTML;
                        }

                        const finalMessage = data.error || data.message || 'Operazione completata.';
                        const finalClass = data.error ? 'error-message' : 'success-message';
                        
                        let progressBarHTML = '';
                        if (!data.error) {
                            progressBarHTML = `<div class="progress-bar-container" style="margin-top: 8px; height: 8px; background-color: #e9ecef; border-radius: 4px; overflow: hidden;"><div class="progress-bar" style="width: 100%; height: 100%; background: var(--gradient-primary);"></div></div>`;
                        }
                        
                        uiElements.messageDiv.className = finalClass;
                        uiElements.messageDiv.innerHTML = `<span>${finalMessage}</span>${progressBarHTML}`;

                    } else {
                        // Il processo è ancora in corso
                        let progressPercent = 0;
                        if (data.total_items > 0) {
                            progressPercent = Math.round((data.processed_items / data.total_items) * 100);
                        }
                        uiElements.messageDiv.className = 'info-message';
                        // Rimuoviamo la chiamata a startTimer da qui
                        uiElements.messageDiv.innerHTML = `
                            <span>${data.message}</span>
                            <div class="progress-bar-container" style="margin-top: 8px; height: 8px; background-color: #e9ecef; border-radius: 4px; overflow: hidden;">
                                <div class="progress-bar" style="width: ${progressPercent}%; height: 100%; background: var(--gradient-primary); transition: width 0.3s ease;"></div>
                            </div>
                        `;
                        // Aggiungiamo il timer al messageDiv se non c'è già
                        if (!uiElements.messageDiv.querySelector('.timer')) {
                            const messageSpan = uiElements.messageDiv.querySelector('span');
                            if (messageSpan) {
                                let timerElement = document.createElement('span');
                                timerElement.className = 'timer';
                                timerElement.style.marginLeft = '15px';
                                timerElement.style.fontStyle = 'italic';
                                messageSpan.appendChild(timerElement);
                            }
                        }
                    }
                } catch (error) {
                    clearInterval(pollingInterval);
                    stopTimer();
                    if (uiElements.button) uiElements.button.disabled = false;
                    uiElements.messageDiv.className = 'error-message';
                    uiElements.messageDiv.textContent = 'Errore di connessione durante il controllo dello stato.';
                }
            }

            // Esponiamo una funzione globale per essere chiamata dalle altre pagine
            window.startAsyncTask = function(endpoint, uiElements) {
                if (pollingInterval) clearInterval(pollingInterval);

                uiElements.button.disabled = true;
                if (uiElements.loader) uiElements.loader.style.display = 'inline';
                uiElements.messageDiv.innerHTML = '';
                uiElements.messageDiv.className = 'info-message';
                uiElements.messageDiv.textContent = 'Avvio operazione...';
                
                // AVVIA IL CRONOMETRO QUI, UNA SOLA VOLTA :
                // TODO: Non va, non lo vedo!
                startTimer(uiElements.messageDiv);

                pollingInterval = setInterval(() => checkProgress(endpoint, uiElements), 2000);
            }
      })();
    </script>
    {% endblock %}
  </body>
</html>
    
  </body>
</html>
