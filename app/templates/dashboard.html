{% extends "base.html" %}

{% block title %} Ingresso dati - Magazzino del Creatore{% endblock %}

{% block content %}
    <h1>Magazzino del Creatore - Ingresso dati</h1>
    <p>Seleziona il tipo di contenuto da aggiungere o aggiornare.</p>

    <div class="accordion-container">
        <!-- Sezione Documenti -->
        <div class="accordion-item">
            <div class="accordion-header">
                <span class="accordion-title">
                    <!-- CORREZIONE: Sostituito <span> con <i> e nome icona corretto -->
                    <i class="fas fa-file-alt"></i>
                    Documenti
                </span>
                <!-- CORREZIONE: Sostituito <span> con <i> per la freccia -->
                <i class="fas fa-chevron-down accordion-arrow"></i>
            </div>
            <div class="accordion-content">
                <p>Carica file PDF, DOCX, TXT per aggiungerli alla base di conoscenza.</p>
                <label for="file-input" class="file-drop-area" id="file-drop-label">
                    <span>Trascina i file qui oppure <strong>scegli i file...</strong></span>
                    <input type="file" id="file-input" name="documents" multiple style="display: none;">
                </label>
                <div id="selected-file-info" style="margin-top: 10px; font-style: italic; color: var(--color-text-light);"></div>
                <button type="button" id="upload-doc-btn" class="action-btn" style="margin-top: 15px;" disabled>Carica Documenti</button>
                <div id="doc-upload-status" style="margin-top:15px;"></div>
            </div>
        </div>

        <!-- Sezione Blog -->
        <div class="accordion-item">
            <div class="accordion-header">
                <span class="accordion-title">
                    <!-- CORREZIONE: Sostituito <span> con <i> e nome icona corretto -->
                    <i class="fas fa-rss"></i>
                    Blog / RSS
                </span>
                <i class="fas fa-chevron-down accordion-arrow"></i>
            </div>
            <div class="accordion-content">
                <p>Inserisci l'URL del feed RSS del tuo blog per indicizzare gli articoli.</p>
                <form id="rss-form">
                    <label for="rss-url">URL Feed RSS:</label>
                    <input type="url" id="rss-url" name="rss_url" placeholder="https://esempio.com/feed/">
                    <div style="display: flex; align-items: center; gap: 10px; margin-top: var(--spacing-sm);">
                        <button type="button" id="process-rss-btn" class="action-btn">Processa Feed</button>
                        <a href="#" id="schedule-rss-btn" class="action-btn" style="display: none; background-color: var(--color-info);" data-url="">Pianifica Ingestione</a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Sezione Video YouTube -->
        <div class="accordion-item">
            <div class="accordion-header">
                <span class="accordion-title">
                    <!-- CORREZIONE: Sostituito <span> con <i> e nome icona corretto -->
                    <i class="fas fa-video"></i>
                    Video YouTube
                </span>
                <i class="fas fa-chevron-down accordion-arrow"></i>
            </div>
            <div class="accordion-content">
                <p>Inserisci l'URL del tuo canale YouTube per aggiungere o aggiornare i video.</p>
                <form id="youtube-form">
                    <label for="channel_url">URL Canale YouTube:</label>
                    <input type="url" id="channel_url" name="channel_url" required placeholder="https://www.youtube.com/@tuocanale">
                    <div style="display: flex; align-items: center; gap: 10px; margin-top: var(--spacing-sm);">
                        <button type="submit" id="process-videos-btn" class="action-btn">Processa Video</button>
                        <a href="#" id="schedule-youtube-btn" class="action-btn" style="display: none; background-color: var(--color-info);" data-url="">Pianifica Ingestione</a>
                    </div>
                </form>
            </div>
        </div>
    </div> <!-- /accordion-container -->

    <!-- Area di stato per processi asincroni -->
    <div id="process-status" style="margin-top: 25px; display: none;">
         <span id="status-message">In attesa...</span>
         <div id="progress-bar-container" style="display: none; margin-top: var(--spacing-sm); height: 8px; background-color: var(--color-border-light); border-radius: 4px; overflow: hidden;">
             <div id="progress-bar" style="width: 0%; height: 100%; background: var(--gradient-primary); transition: width 0.5s ease;"></div>
         </div>
    </div>
{% endblock %}


{% block scripts %}
<script>
    // Lo script JavaScript rimane identico a prima, non c'Ã¨ bisogno di modificarlo.
    // Lo includo qui per completezza del file.
    document.addEventListener('DOMContentLoaded', function() {
        // --- LOGICA ACCORDION ---
        const accordionItems = document.querySelectorAll('.accordion-item');
        accordionItems.forEach(item => {
            const header = item.querySelector('.accordion-header');
            if (header) {
                header.addEventListener('click', () => {
                    // Chiudi tutti gli altri pannelli
                    accordionItems.forEach(otherItem => {
                        if (otherItem !== item) {
                            otherItem.classList.remove('open');
                        }
                    });
                    // Apri o chiudi il pannello cliccato
                    item.classList.toggle('open');
                });
            }
        });
        // Apri il primo di default
        if (accordionItems.length > 0) {
            accordionItems[0].classList.add('open');
        }

        // --- LOGICA DRAG & DROP ---
        const dropArea = document.getElementById('file-drop-label');
        const fileInput = document.getElementById('file-input');
        if(dropArea && fileInput) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                }, false);
            });
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => dropArea.classList.add('dragover'), false);
            });
            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => dropArea.classList.remove('dragover'), false);
            });
            dropArea.addEventListener('drop', (e) => {
                fileInput.files = e.dataTransfer.files;
                const event = new Event('change');
                fileInput.dispatchEvent(event);
            }, false);
        }

        // --- GESTIONE DEI FORM E DEL POLLING (invariato) ---
        const formYoutube = document.getElementById('youtube-form');
        const processBtnYoutube = document.getElementById('process-videos-btn');
        const channelUrlInputYoutube = document.getElementById('channel_url');
        const scheduleYoutubeBtn = document.getElementById('schedule-youtube-btn');
        const uploadDocBtnDocs = document.getElementById('upload-doc-btn');
        const docUploadStatusDocs = document.getElementById('doc-upload-status');
        const selectedFileInfoDocs = document.getElementById('selected-file-info');
        const rssUrlInput = document.getElementById('rss-url');
        const processRssBtn = document.getElementById('process-rss-btn');
        const scheduleRssBtn = document.getElementById('schedule-rss-btn');
        const statusDivAsync = document.getElementById('process-status');
        const statusMessageSpanAsync = document.getElementById('status-message');
        const progressBarContainerAsync = document.getElementById('progress-bar-container');
        const progressBarAsync = document.getElementById('progress-bar');
        
        let progressIntervalYoutube = null;
        let progressIntervalRss = null;
        let currentPollingType = null;
        let lastProcessedYoutubeUrl = null;
        let lastProcessedRssUrl = null;

        function disableAllForms() {
            if(processBtnYoutube) processBtnYoutube.disabled = true;
            if(channelUrlInputYoutube) channelUrlInputYoutube.disabled = true;
            if(uploadDocBtnDocs) uploadDocBtnDocs.disabled = true;
            if(fileInput) fileInput.disabled = true;
            if(processRssBtn) processRssBtn.disabled = true;
            if(rssUrlInput) rssUrlInput.disabled = true;
            if(scheduleYoutubeBtn) { scheduleYoutubeBtn.style.pointerEvents = 'none'; scheduleYoutubeBtn.style.opacity = '0.6'; }
            if(scheduleRssBtn) { scheduleRssBtn.style.pointerEvents = 'none'; scheduleRssBtn.style.opacity = '0.6'; }
        }

        function enableAllForms() {
            if(processBtnYoutube) processBtnYoutube.disabled = false;
            if(channelUrlInputYoutube) channelUrlInputYoutube.disabled = false;
            if(uploadDocBtnDocs && fileInput && fileInput.files.length === 0) {
                uploadDocBtnDocs.disabled = true;
            } else if (uploadDocBtnDocs) {
                uploadDocBtnDocs.disabled = false;
            }
            if(fileInput) fileInput.disabled = false;
            if(processRssBtn) processRssBtn.disabled = false;
            if(rssUrlInput) rssUrlInput.disabled = false;
            if(scheduleYoutubeBtn) { scheduleYoutubeBtn.style.pointerEvents = 'auto'; scheduleYoutubeBtn.style.opacity = '1'; }
            if(scheduleRssBtn) { scheduleRssBtn.style.pointerEvents = 'auto'; scheduleRssBtn.style.opacity = '1'; }
        }

        function resetAsyncStatusUI() {
            if(statusDivAsync) statusDivAsync.style.display = 'none';
            if(statusMessageSpanAsync) statusMessageSpanAsync.textContent = 'In attesa...';
            if(progressBarContainerAsync) progressBarContainerAsync.style.display = 'none';
            if(progressBarAsync) progressBarAsync.style.width = '0%';
            if(statusDivAsync) statusDivAsync.className = '';
            if(scheduleYoutubeBtn) scheduleYoutubeBtn.style.display = 'none';
            if(scheduleRssBtn) scheduleRssBtn.style.display = 'none';
            if(docUploadStatusDocs) { docUploadStatusDocs.innerHTML = ''; docUploadStatusDocs.style.display = 'none'; }
        }

        function updateAsyncStatusUI(message, statusClass = 'processing', progressPercent = null) {
            if(!statusDivAsync || !statusMessageSpanAsync) return;
            statusDivAsync.style.display = 'block';
            statusDivAsync.className = statusClass.includes('-message') ? statusClass : '';
            if(statusClass === 'processing') {
                statusDivAsync.className = 'success-message'; // Usa uno stile neutro/positivo per il processing
                statusDivAsync.style.borderColor = 'var(--color-info)';
            }
            statusMessageSpanAsync.innerHTML = message;
            if (progressPercent !== null && progressBarContainerAsync && progressBarAsync) {
                progressBarContainerAsync.style.display = 'block';
                progressBarAsync.style.width = `${progressPercent}%`;
            } else if (progressBarContainerAsync) {
                progressBarContainerAsync.style.display = 'none';
            }
        }

        if (formYoutube) {
            formYoutube.addEventListener('submit', async function(event) {
                event.preventDefault();
                if (currentPollingType) return;
                const channelUrl = channelUrlInputYoutube.value;
                if (!channelUrl) return;

                lastProcessedYoutubeUrl = channelUrl;
                disableAllForms();
                resetAsyncStatusUI();
                updateAsyncStatusUI('Avvio elaborazione canale... <span class="loading-spinner" style="border-top-color: var(--color-primary); width: 1em; height: 1em; display: inline-block; vertical-align: middle; margin-left: 8px; animation: spin 1s linear infinite;"></span>', 'processing');
                processBtnYoutube.textContent = 'Elaborazione...';
                currentPollingType = 'youtube';

                try {
                    const response = await fetch('/api/videos/channel', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                        body: JSON.stringify({ channel_url: channelUrl })
                    });
                    const data = await response.json();
                    if (response.status === 202 && data.success) {
                        updateAsyncStatusUI('Elaborazione avviata... <span class="loading-spinner" style="border-top-color: var(--color-primary); width: 1em; height: 1em; display: inline-block; vertical-align: middle; margin-left: 8px; animation: spin 1s linear infinite;"></span>', 'processing');
                        startProgressPollingYoutube();
                    } else {
                        throw new Error(data.message || `Errore ${response.status}`);
                    }
                } catch (error) {
                     updateAsyncStatusUI(`Errore: ${error.message}`, 'error-message');
                     enableAllForms();
                     processBtnYoutube.textContent = 'Processa Video';
                     currentPollingType = null;
                }
            });
        }
        
        function startProgressPollingYoutube() {
             clearInterval(progressIntervalYoutube);
             clearInterval(progressIntervalRss);
             progressIntervalYoutube = setInterval(checkProgressYoutube, 2000);
        }

        async function checkProgressYoutube() {
            if (currentPollingType !== 'youtube') {
                clearInterval(progressIntervalYoutube); return;
            }
            try {
                const response = await fetch('/api/videos/progress');
                const progressData = await response.json();
                if (progressData.is_processing) {
                    let msg = progressData.message || 'Elaborazione in corso...';
                    let perc = null;
                    if (progressData.current_video) {
                         const current = progressData.current_video.index;
                         const total = progressData.current_video.total;
                         perc = total > 0 ? Math.round((current / total) * 100) : 0;
                         msg = `(${current}/${total}) ${progressData.current_video.title || 'video...'}`;
                    }
                    updateAsyncStatusUI(`${msg} <span class="loading-spinner" style="border-top-color: var(--color-primary); width: 1em; height: 1em; display: inline-block; vertical-align: middle; margin-left: 8px; animation: spin 1s linear infinite;"></span>`, 'processing', perc);
                } else {
                    clearInterval(progressIntervalYoutube);
                    const finalMessage = progressData.message || 'Elaborazione completata.';
                    const finalStatusClass = finalMessage.toLowerCase().includes("errore") ? 'error-message' : 'success-message';
                    updateAsyncStatusUI(finalMessage, finalStatusClass, 100);
                    enableAllForms();
                    processBtnYoutube.textContent = 'Processa Video';
                    currentPollingType = null;
                    if (finalStatusClass === 'success-message' && lastProcessedYoutubeUrl && scheduleYoutubeBtn) {
                        scheduleYoutubeBtn.setAttribute('data-url', lastProcessedYoutubeUrl);
                        scheduleYoutubeBtn.style.display = 'inline-block';
                    }
                }
            } catch (error) {
                 clearInterval(progressIntervalYoutube);
                 updateAsyncStatusUI('Errore nel controllo dello stato.', 'error-message');
                 enableAllForms();
                 processBtnYoutube.textContent = 'Processa Video';
                 currentPollingType = null;
            }
        }

        if (fileInput) {
            fileInput.addEventListener('change', () => {
                if (fileInput.files.length > 0) {
                     selectedFileInfoDocs.textContent = `${fileInput.files.length} file selezionati.`;
                     uploadDocBtnDocs.disabled = false;
                 } else {
                     selectedFileInfoDocs.textContent = '';
                     uploadDocBtnDocs.disabled = true;
                 }
            });
        }
        
        if (uploadDocBtnDocs) {
            uploadDocBtnDocs.addEventListener('click', async () => {
                if (fileInput.files.length === 0) return;
                const formData = new FormData();
                for (const file of fileInput.files) { formData.append('documents', file); }
                
                docUploadStatusDocs.innerHTML = `Caricamento... <span class="loading-spinner" style="border-top-color: var(--color-primary); width: 1em; height: 1em; display: inline-block; vertical-align: middle; margin-left: 8px; animation: spin 1s linear infinite;"></span>`;
                docUploadStatusDocs.className = 'success-message'; // Stile neutro
                docUploadStatusDocs.style.display = 'block';
                uploadDocBtnDocs.disabled = true;

                try {
                    const response = await fetch('/api/documents/upload', { method: 'POST', body: formData });
                    const data = await response.json();
                    if (response.ok) {
                        docUploadStatusDocs.textContent = data.message || `Caricamento completato!`;
                        docUploadStatusDocs.className = 'success-message';
                    } else {
                         throw new Error(data.message || `Errore ${response.status}`);
                    }
                } catch (error) {
                    docUploadStatusDocs.textContent = `Errore: ${error.message}`;
                    docUploadStatusDocs.className = 'error-message';
                } finally {
                    uploadDocBtnDocs.disabled = true;
                    fileInput.value = '';
                    selectedFileInfoDocs.textContent = '';
                }
            });
        }

        if(processRssBtn) {
            processRssBtn.addEventListener('click', async () => {
                if (currentPollingType) return;
                const feedUrl = rssUrlInput.value.trim();
                if (!feedUrl) return;

                lastProcessedRssUrl = feedUrl;
                disableAllForms();
                resetAsyncStatusUI();
                updateAsyncStatusUI('Avvio elaborazione RSS... <span class="loading-spinner" style="border-top-color: var(--color-primary); width: 1em; height: 1em; display: inline-block; vertical-align: middle; margin-left: 8px; animation: spin 1s linear infinite;"></span>', 'processing');
                processRssBtn.textContent = 'Processo...';
                currentPollingType = 'rss';

                try {
                     const response = await fetch('/api/rss/process', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ rss_url: feedUrl }) });
                     const data = await response.json();
                     if (response.status === 202) {
                         updateAsyncStatusUI('Elaborazione RSS avviata... <span class="loading-spinner" style="border-top-color: var(--color-primary); width: 1em; height: 1em; display: inline-block; vertical-align: middle; margin-left: 8px; animation: spin 1s linear infinite;"></span>', 'processing');
                         startProgressPollingRss();
                     } else {
                         throw new Error(data.message || `Errore ${response.status}`);
                     }
                } catch (error) {
                     updateAsyncStatusUI(`Errore: ${error.message}`, 'error-message');
                     enableAllForms();
                     processRssBtn.textContent = 'Processa Feed';
                     currentPollingType = null;
                }
            });
        }
        
        function startProgressPollingRss() {
             clearInterval(progressIntervalRss);
             clearInterval(progressIntervalYoutube);
             progressIntervalRss = setInterval(checkProgressRss, 2000);
        }

        async function checkProgressRss() {
            if (currentPollingType !== 'rss') { clearInterval(progressIntervalRss); return; }
            try {
                const response = await fetch('/api/rss/progress');
                const progressData = await response.json();
                if (progressData.is_processing) {
                    updateAsyncStatusUI(`${progressData.message || 'Elaborazione RSS...'} <span class="loading-spinner" style="border-top-color: var(--color-primary); width: 1em; height: 1em; display: inline-block; vertical-align: middle; margin-left: 8px; animation: spin 1s linear infinite;"></span>`, 'processing');
                } else {
                    clearInterval(progressIntervalRss);
                    const finalMessage = progressData.message || 'Elaborazione RSS completata.';
                    const finalStatusClass = progressData.error ? 'error-message' : 'success-message';
                    updateAsyncStatusUI(progressData.error || finalMessage, finalStatusClass);
                    enableAllForms();
                    processRssBtn.textContent = 'Processa Feed';
                    currentPollingType = null;
                    if (finalStatusClass === 'success-message' && lastProcessedRssUrl && scheduleRssBtn) {
                        scheduleRssBtn.setAttribute('data-url', lastProcessedRssUrl);
                        scheduleRssBtn.style.display = 'inline-block';
                    }
                }
            } catch (error) {
                 clearInterval(progressIntervalRss);
                 updateAsyncStatusUI('Errore nel controllo dello stato.', 'error-message');
                 enableAllForms();
                 processRssBtn.textContent = 'Processa Feed';
                 currentPollingType = null;
            }
        }
        
        if(scheduleYoutubeBtn) {
            scheduleYoutubeBtn.addEventListener('click', function(e) {
                e.preventDefault();
                const url = e.target.getAttribute('data-url');
                if(url) window.location.href = `/automations?type=youtube&url=${encodeURIComponent(url)}`;
            });
        }
        if(scheduleRssBtn) {
            scheduleRssBtn.addEventListener('click', function(e) {
                e.preventDefault();
                const url = e.target.getAttribute('data-url');
                if(url) window.location.href = `/automations?type=rss&url=${encodeURIComponent(url)}`;
            });
        }
    });
</script>
{% endblock %}