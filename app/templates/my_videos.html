{% extends "base.html" %}

{% block title %}I tuoi video - Magazzino del Creatore{% endblock %}

{% block content %}
    <h1>I tuoi video salvati ({{ videos|length }})</h1>

    <div class="action-panel">
        <a href="{{ url_for('videos.download_all_transcripts') }}" class="action-btn success-btn">
            <i class="fas fa-download fa-fw"></i>
            <span>Scarica trascrizioni (.txt)</span>
        </a>
        <span style="font-size: 0.9em; color: var(--color-text-light);">(Solo video 'completed')</span>
        {% if config.APP_MODE == 'saas' %}
            <button id="delete-all-videos-btn" class="action-btn delete-btn" style="margin-left: auto;">
                <i class="fas fa-trash-alt fa-fw"></i>
                <span>Elimina tutti</span>
            </button>
        {% endif %}
    </div>

    <div id="action-message"></div>

    <div id="videos-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Titolo</th>
                    <th>Data Pubblicazione</th>
                    <th>Stato</th>
                    <th>Tipo Sottotitoli</th>
                    <th>Lingua</th>
                    <th>Anteprima Trascrizione</th>
                    <th>Azioni</th>
                </tr>
            </thead>
            <tbody>
                {% for video in videos %}
                <tr id="video-row-{{ video.video_id | escape }}">
                    <td><a href="{{ video.url }}" target="_blank" title="{{ video.title }}">{{ video.title }}</a></td>
                    <td>{{ video.published_at | format_date }}</td>
                    <td id="status-{{ video.video_id | escape }}">
                        <span class="status-badge status-{{ video.processing_status | lower | replace('_','-') }}">{{ video.processing_status }}</span>
                    </td>
                    <td>
                        {% if video.captions_type %}
                            {{ video.captions_type }}
                        {% else %}
                            N/D
                        {% endif %}
                    </td>
                    <td>{{ video.transcript_language if video.transcript_language else 'N/D' }}</td>
                    <td>
                        {% if video.transcript %}
                            <p style="font-size: 0.9em; color: var(--color-text-secondary); margin: 0;">
                                {{ video.transcript[:100] }}{% if video.transcript|length > 100 %}...{% endif %}
                            </p>
                        {% else %}
                            <span style="color: var(--color-text-light); font-style: italic;">Nessuna</span>
                        {% endif %}
                    </td>
                    <td>
                        <button class="action-btn reprocess-btn" data-video-id="{{ video.video_id | trim | escape }}">
                            <i class="fas fa-sync-alt fa-fw"></i>
                            {% if video.processing_status == 'completed' %}
                                <span>Riprocessa (Completo)</span>
                            {% else %}
                                <span>Riprocessa</span>
                            {% endif %}
                        </button>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7" class="no-items-message">
                        Nessun video trovato nel database.<br>
                        Vai su <a href="{{ url_for('data_entry') }}">Ingresso Dati</a> per processare un canale.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const messageDiv = document.getElementById("action-message");

    function showNotification(message, type = "success") {
      if (!messageDiv) return;
      messageDiv.className =
        type === "success" ? "success-message" : "error-message";
      messageDiv.textContent = message;
      messageDiv.style.opacity = "0";
      messageDiv.style.display = "flex";
      setTimeout(() => {
        messageDiv.style.opacity = "1";
      }, 10);
      setTimeout(() => {
        messageDiv.style.opacity = "0";
        setTimeout(() => {
          messageDiv.style.display = "none";
        }, 500);
      }, 5000);
    }

    const confirmModal = document.getElementById("confirm-modal");
    const confirmOverlay = document.getElementById("confirm-modal-overlay");
    const confirmOkBtn = document.getElementById("confirm-modal-ok");
    const confirmCancelBtn = document.getElementById("confirm-modal-cancel");
    const confirmTitle = document.getElementById("confirm-modal-title");
    const confirmText = document.getElementById("confirm-modal-text");

    
    document.querySelectorAll(".reprocess-btn").forEach((button) => {
      const originalButtonHTML = button.innerHTML;
      button.addEventListener("click", async (event) => {
        const btn = event.currentTarget;
        const videoId = btn.dataset.videoId;
        const statusCell = document.getElementById(`status-${videoId}`);

        if (!videoId || !statusCell) return;

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        statusCell.innerHTML = `<span class="status-badge status-processing">processing</span>`;

        const response = await fetch(`/api/videos/${videoId}/reprocess`, {
          method: "POST",
          headers: { Accept: "application/json" },
        });

        if (response.status === 401) {
          const data = await response.json();
          const userConfirmed = await showConfirmModal(
            "Autorizzazione Richiesta",
            "La tua autorizzazione per YouTube è scaduta. Vuoi essere reindirizzato per ri-autenticarti ora?"
          );
          if (userConfirmed) {
            window.location.href = data.redirect_url;
          }
          btn.disabled = false;
          btn.innerHTML = originalButtonHTML;
          statusCell.innerHTML = `<span class="status-badge status-unknown">Reauth Needed</span>`;
          return;
        }

        try {
          const data = await response.json();
          const statusClass = data.new_status.toLowerCase().replace(/_/g, "-");
          statusCell.innerHTML = `<span class="status-badge status-${statusClass}">${data.new_status}</span>`;
          if (!response.ok || !data.success) {
            throw new Error(data.message || `Errore ${response.status}`);
          }
          showNotification(data.message || "Operazione completata.", "success");
        } catch (error) {
          showNotification(error.message, "error");
        } finally {
          if (response.status !== 401) {
            btn.disabled = false;
            btn.innerHTML = originalButtonHTML;
          }
        }
      });
    });

    const deleteAllBtn = document.getElementById("delete-all-videos-btn");
    if (deleteAllBtn) {
      deleteAllBtn.addEventListener("click", async () => {
        const userConfirmed = await showConfirmModal(
          "Conferma eliminazione",
          "ATTENZIONE! Sei sicuro di voler eliminare TUTTI i video? L'azione è irreversibile."
        );
        if (!userConfirmed) return;

        const originalHTML = deleteAllBtn.innerHTML;
        deleteAllBtn.disabled = true;
        deleteAllBtn.textContent = "Eliminazione...";

        try {
          const response = await fetch("/api/videos/all", {
            method: "DELETE",
            headers: { Accept: "application/json" },
          });
          const data = await response.json();
          if (response.ok && data.success) {
            showNotification(data.message, "success");
            document.querySelector(
              ".data-table tbody"
            ).innerHTML = `<tr><td colspan="7" class="no-items-message">Nessun video da mostrare.</td></tr>`;
            deleteAllBtn.textContent = "Eliminati";
          } else {
            throw new Error(data.message);
          }
        } catch (error) {
          showNotification(error.message, "error");
          deleteAllBtn.disabled = false;
          deleteAllBtn.innerHTML = originalHTML;
        }
      });

      const isTableEmpty = !document.querySelector(
        "#videos-container tbody tr:not(:has(.no-items-message))"
      );
      if (isTableEmpty) {
        deleteAllBtn.disabled = true;
      }
    }
  });
</script>
{% endblock %}