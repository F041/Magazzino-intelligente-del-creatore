<!-- FILE: app/templates/my_videos.html (Modificato per estendere base.html) -->
{% extends "base.html" %}

{% block title %}I tuoi video - Magazzino del Creatore{% endblock %}

{% block content %}
    <h1>I tuoi video salvati nel Database ({{ videos|length }})</h1>

    <!-- Sezione Pulsanti Azione di Massa -->
    <div style="margin-bottom: 20px; padding: 10px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; display: flex; align-items: center; gap: 15px;">
        {# Bottone Download Esistente #}
        <a href="{{ url_for('videos.download_all_transcripts') }}" download="all_video_transcripts.txt" class="action-btn" style="background-color: #28a745; color: white; text-decoration: none; display: inline-block; padding: 8px 15px;">
            Scarica Tutte le Trascrizioni (.txt)
        </a>
        <span style="font-size: 0.9em; color: #6c757d;">(Solo video 'completed')</span>

        {# ---  BOTTONE ELIMINA TUTTO --- #}
        {# Visibile solo se APP_MODE è 'saas' (per sicurezza) #}
        {% if config.APP_MODE == 'saas' %}
            <button id="delete-all-videos-btn" class="action-btn delete-btn" style="margin-left: auto;">
                Elimina tutti i video utente
            </button>
            <span id="delete-all-loader" class="action-loader" style="display: none;">(eliminazione...)</span>
        {% endif %}
      
    </div>
    <!-- Fine Sezione Pulsanti Azione di Massa -->

    <div id="reprocess-message"></div> {# Div per messaggi riprocessamento #}
    <div id="videos-container">
        <table class="data-table"> {# Usata classe comune .data-table #}
            <thead>
                <tr>
                    <th>Titolo</th>
                    <th>Data Pubblicazione</th>
                    <th>Stato Processo</th>
                    <th>Tipo Sottotitoli</th>
                    <th>Lingua</th>
                    <th>Anteprima Trascrizione</th>
                    <th>Azioni</th>
                </tr>
            </thead>
            <tbody>
                {% for video in videos %}
                <tr>
                    <td><a href="{{ video.url }}" target="_blank">{{ video.title }}</a></td>
                    <td>{{ video.published_at | format_date }}</td>
                    <td id="status-{{ video.video_id | escape }}">
                        <span class="status-badge status-{{ video.processing_status | lower | replace('_','-') }}">{{ video.processing_status }}</span>
                    </td>
                    <td>
                        {% if video.captions_type %}
                            <span class="caption-type {{ video.captions_type }}">{{ video.captions_type }}</span>
                        {% else %}
                            <span class="caption-type none">None</span>
                        {% endif %}
                    </td>
                    <td>{{ video.transcript_language if video.transcript_language else 'N/D' }}</td>
                    <td>
                        {% if video.transcript %}
                            <div class="transcript-preview">{{ video.transcript[:150] }}{% if video.transcript|length > 150 %}...{% endif %}</div>
                        {% else %}
                            <div class="transcript-preview">Nessuna trascrizione disponibile</div>
                        {% endif %}
                    </td>
                    <td>
                        {# {% if video.processing_status not in ['processing', 'completed'] %} #}
                        <button class="action-btn reprocess-btn" data-video-id="{{ video.video_id | trim | escape }}">
                                <i class="fas fa-sync-alt fa-fw"></i>
                                <!-- RIPRISTINATA la logica per il testo del bottone -->
                                {% if video.processing_status == 'completed' %}
                                    <span>Riprocessa (Completo)</span>
                                {% else %}
                                    <span>Riprocessa</span>
                                {% endif %}
                            </button>
                            <!-- CORRETTO: Il loader è nascosto di default -->
                            <span class="action-loader reprocess-loader" style="display: none;">(loading...)</span>
                    {# {% endif %} #}
                </td>       
                </tr>
                {% else %}
                <tr>
                    <td colspan="7" class="no-items-message">
                        Nessun video trovato nel database.
<br>Vai alla <a href="{{ url_for('data_entry') }}">data_entry</a> per cercare e processare video da un canale.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Selezioniamo il div per i messaggi globali
    const messageDiv = document.getElementById('action-message');

    // Funzione helper per mostrare i banner di notifica
    function showNotification(message, type = 'success') {
        if (!messageDiv) return;
        
        // Applichiamo le classi corrette per lo stile
        messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
        messageDiv.textContent = message;
        
        // Stili per l'apparizione
        messageDiv.style.opacity = '0';
        messageDiv.style.display = 'flex'; // Usiamo flex per centrare l'icona
        
        // Animazione di fade-in
        setTimeout(() => { messageDiv.style.opacity = '1'; }, 10);

        // Nascondi dopo 5 secondi
        setTimeout(() => {
            messageDiv.style.opacity = '0';
            // Aspetta la fine della transizione prima di nascondere completamente
            setTimeout(() => { messageDiv.style.display = 'none'; }, 500);
        }, 5000);
    }

    // --- Logica Pulsante RIPROCESSA ---
    document.querySelectorAll('.reprocess-btn').forEach(button => {
        const originalButtonHTML = button.innerHTML;
        button.addEventListener('click', async (event) => {
            const btn = event.currentTarget;
            const videoId = btn.dataset.videoId;
            const statusCell = document.getElementById(`status-${videoId}`);

            if (!videoId || !statusCell) {
                showNotification('Errore interno: Impossibile identificare il video.', 'error');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '...';
            statusCell.innerHTML = `<span class="status-badge status-processing">processing</span>`;

            try {
                const response = await fetch(`/api/videos/${videoId}/reprocess`, {
                    method: 'POST',
                    headers: { 'Accept': 'application/json' }
                });
                const data = await response.json();
                
                const statusClass = data.new_status.toLowerCase().replace(/_/g, '-');
                statusCell.innerHTML = `<span class="status-badge status-${statusClass}">${data.new_status}</span>`;

                if (!response.ok || !data.success) {
                    throw new Error(data.message || `Errore ${response.status}`);
                }
                
                // Mostra notifica di successo
                showNotification(data.message || 'Operazione completata con successo.', 'success');

            } catch (error) {
                // Mostra notifica di errore
                showNotification(error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalButtonHTML;
            }
        });
    });

    // --- Logica Pulsante ELIMINA TUTTI (adattata per usare le notifiche) ---
    const deleteAllBtn = document.getElementById('delete-all-videos-btn');
    if (deleteAllBtn) {
        deleteAllBtn.addEventListener('click', async () => {
            if (!confirm("ATTENZIONE! Sei sicuro di voler eliminare TUTTI i video? L'azione è irreversibile.")) return;

            const originalHTML = deleteAllBtn.innerHTML;
            deleteAllBtn.disabled = true;
            deleteAllBtn.textContent = 'Eliminazione...';

            try {
                const response = await fetch('/api/videos/all', {
                    method: 'DELETE',
                    headers: { 'Accept': 'application/json' }
                });
                const data = await response.json();
                if (response.ok && data.success) {
                    showNotification(data.message, 'success');
                    document.querySelector('.data-table tbody').innerHTML = `<tr><td colspan="5" class="no-items-message">Nessun video da mostrare.</td></tr>`;
                    deleteAllBtn.textContent = 'Eliminati';
                } else {
                    throw new Error(data.message || `Errore ${response.status}`);
                }
            } catch (error) {
                showNotification(error.message, 'error');
                deleteAllBtn.disabled = false;
                deleteAllBtn.innerHTML = originalHTML;
            }
        });
        
        const isTableEmpty = !document.querySelector('#videos-container tbody tr:not(:has(.no-items-message))');
        if (isTableEmpty) { deleteAllBtn.disabled = true; }
    }
});
</script>
{% endblock %}```
