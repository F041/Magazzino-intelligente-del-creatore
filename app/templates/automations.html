{% extends "base.html" %}

{% block title %}Automazioni - Magazzino del Creatore{% endblock %}

{% block content %}
<h1>Gestione Automazioni</h1>
<p>Configura qui le sorgenti da controllare automaticamente per nuovi contenuti e la frequenza dei controlli.</p>

<!-- Sezione Stato Attuale -->
<div class="form-section">
    <h2>Stato Monitoraggio Attuale</h2>
    <div id="monitoring-status-display">
        <p>Caricamento stato...</p>
    </div>
</div>

<!-- Sezione Aggiungi/Modifica Sorgente -->
<div class="form-section">
    <h2>Aggiungi o Modifica Sorgente</h2>
    <form id="add-source-form">
        <div class="form-group">
            <label for="source_type">Tipo Sorgente:</label>
            <select id="source_type" name="type" required>
                <option value="">-- Seleziona Tipo --</option>
                <option value="youtube">Canale YouTube</option>
                <option value="rss">Feed RSS</option>
            </select>
        </div>
        <div class="form-group">
            <label for="source_url">URL Sorgente:</label>
            <input type="url" id="source_url" name="url" placeholder="Incolla l'URL del canale o del feed" required>
        </div>
        <button type="submit" id="save-source-btn" class="action-btn">Salva e Attiva</button>
        <span id="save-loader" class="action-loader" style="display: none;">(salvataggio...)</span>
    </form>
    <div id="form-message" style="display: none;"></div>
</div>

<!-- NUOVA SEZIONE: Frequenza Controlli -->
<div class="form-section">
    <h2>Frequenza Controlli</h2>
    <p>Imposta quanto spesso il sistema deve controllare automaticamente le fonti attive per nuovi contenuti.</p>
    <form id="schedule-form">
         <div class="form-group">
            <label for="schedule_interval">Controlla ogni:</label>
            <select id="schedule_interval" name="interval">
                <option value="12 hours">12 Ore</option>
                <option value="1 day" selected>Giorno</option>
                <option value="2 days">2 Giorni</option>
                <option value="1 week">Settimana</option>
            </select>
        </div>
        <button type="submit" class="action-btn">Aggiorna Frequenza</button>
    </form>
</div>
{% endblock %}

{% block scripts %}

<!-- 1. Dati Iniziali dal Server (per il pre-caricamento del form) -->
<script id="initial-data-json" type="application/json">
    {{ {'initial_type': initial_type, 'initial_url': initial_url} | tojson | safe }}
</script>

<!-- 2. Script Principale della Pagina -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- SELEZIONE ELEMENTI DOM ---
    const statusDisplayDiv = document.getElementById('monitoring-status-display');
    const addForm = document.getElementById('add-source-form');
    const typeSelect = document.getElementById('source_type');
    const urlInput = document.getElementById('source_url');
    const saveBtn = document.getElementById('save-source-btn');
    const saveLoader = document.getElementById('save-loader');
    const formMessageDiv = document.getElementById('form-message');
    // Non abbiamo più un form per la frequenza, quindi questi elementi non servono più
    // const scheduleForm = document.getElementById('schedule-form');
    // const scheduleSelect = document.getElementById('schedule_interval');
    
    // --- FUNZIONE PER CARICARE E VISUALIZZARE LO STATO ---
    async function loadMonitoringStatus() {
        if (!statusDisplayDiv) return;
        statusDisplayDiv.innerHTML = '<p>Caricamento stato...</p>';
        try {
            const response = await fetch('/api/monitoring/status');
            if (!response.ok) throw new Error(`Errore API ${response.status}`);
            const data = await response.json();

            if (data.success) {
                let html = '<h4>Canale YouTube Monitorato:</h4>';
                if (data.youtube_channel && data.youtube_channel.is_active) {
                    const ch = data.youtube_channel;
                    const lastChecked = ch.last_checked_at ? new Date(ch.last_checked_at).toLocaleString() : 'Mai';
                    html += `
                        <div class="status-display">
                            <p><strong>Nome:</strong> ${ch.channel_name || '(Non disponibile)'}</p>
                            <p><strong>URL:</strong> ${ch.channel_url || 'N/D'}</p>
                            <p><strong>Ultimo Controllo:</strong> ${lastChecked}</p>
                            <p><strong>Stato:</strong> Attivo</p>
                            <button class="action-btn delete-btn remove-source-btn" data-type="youtube">Disattiva Monitoraggio YouTube</button>
                        </div>`;
                } else {
                    html += '<p class="none-active" style="color: var(--color-text-light); font-style: italic;">Nessun canale YouTube monitorato.</p>';
                }

                html += '<hr style="margin: 20px 0;"><h4>Feed RSS Monitorato:</h4>';
                if (data.rss_feed && data.rss_feed.is_active) {
                    const fd = data.rss_feed;
                    const lastChecked = fd.last_checked_at ? new Date(fd.last_checked_at).toLocaleString() : 'Mai';
                    html += `
                         <div class="status-display">
                            <p><strong>Titolo:</strong> ${fd.feed_title || '(Non disponibile)'}</p>
                            <p><strong>URL:</strong> ${fd.feed_url || 'N/D'}</p>
                            <p><strong>Ultimo Controllo:</strong> ${lastChecked}</p>
                            <p><strong>Stato:</strong> Attivo</p>
                            <button class="action-btn delete-btn remove-source-btn" data-type="rss">Disattiva Monitoraggio RSS</button>
                        </div>`;
                } else {
                    html += '<p class="none-active" style="color: var(--color-text-light); font-style: italic;">Nessun feed RSS monitorato.</p>';
                }
                statusDisplayDiv.innerHTML = html;
                addRemoveListeners(); // Aggiungi listener ai nuovi bottoni
            } else {
                throw new Error(data.message || 'Errore caricamento stato');
            }
        } catch (error) {
            statusDisplayDiv.innerHTML = `<p class="error-message">Errore: ${error.message}</p>`;
        }
    }

    // --- FUNZIONE PER AGGIUNGERE LISTENER AI PULSANTI "RIMUOVI" ---
    function addRemoveListeners() {
        statusDisplayDiv.querySelectorAll('.remove-source-btn').forEach(button => {
            button.addEventListener('click', async (event) => {
                const btn = event.target;
                const sourceType = btn.dataset.type;
                if (!sourceType || !confirm(`Disattivare il monitoraggio per ${sourceType}?`)) return;

                btn.disabled = true;
                btn.textContent = 'Disattivazione...';
                displayFormMessage('');

                try {
                    const response = await fetch('/api/monitoring/source', {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ type: sourceType })
                    });
                    const data = await response.json();
                    if (response.ok && data.success) {
                        displayFormMessage(data.message || 'Monitoraggio disattivato.', 'success');
                        loadMonitoringStatus();
                    } else {
                        throw new Error(data.message || `Errore ${response.status}`);
                    }
                } catch (error) {
                    displayFormMessage(`Errore: ${error.message}`, 'error');
                    btn.disabled = false;
                    btn.textContent = `Disattiva Monitoraggio ${sourceType === 'youtube' ? 'YouTube' : 'RSS'}`;
                }
            });
        });
    }

    // --- FUNZIONE PER VISUALIZZARE MESSAGGI DEL FORM ---
    function displayFormMessage(message, type = 'info') {
        if (!formMessageDiv) return;
        formMessageDiv.textContent = message;
        formMessageDiv.className = type === 'success' ? 'success-message' : (type === 'error' ? 'error-message' : '');
        formMessageDiv.style.display = message ? 'block' : 'none';
        setTimeout(() => { if(formMessageDiv) formMessageDiv.style.display = 'none'; }, 5000);
    }

    // --- GESTIONE SUBMIT FORM AGGIUNGI/MODIFICA ---
    if (addForm) {
        addForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const sourceType = typeSelect.value;
            const sourceUrl = urlInput.value.trim();

            if (!sourceType || !sourceUrl) {
                displayFormMessage('Seleziona un tipo e inserisci un URL.', 'error');
                return;
            }

            saveBtn.disabled = true;
            saveLoader.style.display = 'inline';
            displayFormMessage('');

            try {
                const response = await fetch('/api/monitoring/source', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: sourceType, url: sourceUrl })
                });
                const data = await response.json();
                if (response.ok && data.success) {
                    displayFormMessage(data.message || 'Sorgente salvata!', 'success');
                    loadMonitoringStatus();
                    addForm.reset(); // Pulisce il form
                } else {
                    throw new Error(data.message || `Errore ${response.status}`);
                }
            } catch (error) {
                displayFormMessage(`Errore salvataggio: ${error.message}`, 'error');
            } finally {
                saveBtn.disabled = false;
                saveLoader.style.display = 'none';
            }
        });
    }

    // --- INIZIALIZZAZIONE PAGINA ---
    let initialType = null;
    let initialUrl = null;
    try {
        const jsonDataElement = document.getElementById('initial-data-json');
        if (jsonDataElement) {
            const initialData = JSON.parse(jsonDataElement.textContent || '{}');
            initialType = initialData.initial_type;
            initialUrl = initialData.initial_url;
        }
    } catch (e) {
        console.error("Errore parsing dati iniziali:", e);
    }
    
    if (initialType && initialUrl) {
        if (typeSelect) typeSelect.value = initialType;
        if (urlInput) urlInput.value = initialUrl;
        displayFormMessage(`Pronto per aggiungere/aggiornare la sorgente: ${initialUrl}`, 'info');
    }

    // Carica lo stato iniziale
    loadMonitoringStatus();
});
</script>
{% endblock %}