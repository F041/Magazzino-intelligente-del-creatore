{% extends "base.html" %}

{% block title %}STATistiche - Magazzino del Creatore{% endblock %}

{% block head_styles %}
    {# Ora linkiamo il nostro nuovo file CSS dedicato #}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/statistics.css') }}">
{% endblock %}

{% block content %}
    <h1>Le tue STATistiche</h1>
    <p>Analisi quantitative dei tuoi contenuti per aiutarti a capire meglio il tuo magazzino. I calcoli si basano solo sui contenuti che sono stati processati con successo.</p>

    <!-- Contenitore nascosto per passare i dati da Python a JavaScript in modo pulito -->
    <div id="stats-data-container" data-stats='{{ stats_data | tojson | safe }}' style="display: none;"></div>

    {# Pannello con il pulsante di Ricalcolo #}
    <div class="action-panel">
        <form action="{{ url_for('statistics.recalculate_stats') }}" method="POST" id="recalculate-form">
            <button type="submit" id="recalculate-stats-btn" class="action-btn secondary">
                <i class="fas fa-sync-alt"></i> Ricalcola statistiche per contenuti esistenti
            </button>
        </form>
    </div>

    {# Area per mostrare messaggi di successo o errore (es. dopo il ricalcolo) #}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="{{ 'success-message' if category == 'success' else 'error-message' }}" style="margin-bottom: 20px;">
                    <span>{{ message }}</span>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    {% if stats_data.error %}
        <div class="error-message">{{ stats_data.error }}</div>
    {% else %}
    
    {# --- SEZIONE 1: GRIGLIA DEI CONTENUTI --- #}
    <div class="stats-grid">
        
        {# Scheda per i VIDEO #}
        <div class="stat-card">
            <h3><i class="fas fa-video fa-fw"></i> Video ({{ stats_data.videos.count if stats_data.videos else 0 }})</h3>
            {% if stats_data.videos and stats_data.videos.count > 0 %}
                <div class="metrics-container">
                    <div class="metric-item"><div class="value">{{ stats_data.videos.avg_word_count }}</div><div class="label">Parole medie</div></div>
                    <div class="metric-item"><div class="value">{{ stats_data.videos.avg_gunning_fog }}</div><div class="label">Indice leggibilità
                                                    <span class="info-tooltip">
                                <i class="fas fa-info-circle"></i>
                                <span class="tooltip-text">L'indice Gunning fog stima gli anni di istruzione formale necessari per comprendere il testo. Un punteggio tra 10-14 è considerato ideale per un pubblico vasto. Valori più alti indicano maggiore complessità.</span>
                            </span>
                   </div></div>
                </div>
                <div class="chart-container"><canvas id="video-chart"></canvas></div>
            {% else %}
                <p class="no-data-message">Nessun video trovato o processato.</p>
            {% endif %}
        </div>

        {# Scheda per i DOCUMENTI #}
        <div class="stat-card">
            <h3><i class="fas fa-file-alt fa-fw"></i> Documenti ({{ stats_data.documents.count if stats_data.documents else 0 }})</h3>
            {% if stats_data.documents and stats_data.documents.count > 0 %}
                <div class="metrics-container">
                    <div class="metric-item"><div class="value">{{ stats_data.documents.avg_word_count }}</div><div class="label">Parole medie</div></div>
                    <div class="metric-item"><div class="value">{{ stats_data.documents.avg_gunning_fog }}</div><div class="label">Indice leggibilità
                                                    <span class="info-tooltip">
                                <i class="fas fa-info-circle"></i>
                                <span class="tooltip-text">L'indice Gunning fog stima gli anni di istruzione formale necessari per comprendere il testo. Un punteggio tra 10-14 è considerato ideale per un pubblico vasto. Valori più alti indicano maggiore complessità.</span>
                            </span>
                    </div></div>

                </div>
                <div class="chart-container"><canvas id="document-chart"></canvas></div>
            {% else %}
                <p class="no-data-message">Nessun documento trovato o processato.</p>
            {% endif %}
        </div>

        {# Scheda per gli ARTICOLI #}
        <div class="stat-card">
            <h3><i class="fas fa-newspaper fa-fw"></i> Articoli ({{ stats_data.articles.count if stats_data.articles else 0 }})</h3>
            {% if stats_data.articles and stats_data.articles.count > 0 %}
                <div class="metrics-container">
                    <div class="metric-item"><div class="value">{{ stats_data.articles.avg_word_count }}</div><div class="label">Parole medie</div></div>
                    <div class="metric-item"><div class="value">{{ stats_data.articles.avg_gunning_fog }}</div><div class="label">Indice leggibilità
                                                    <span class="info-tooltip">
                                <i class="fas fa-info-circle"></i>
                                <span class="tooltip-text">L'indice Gunning fog stima gli anni di istruzione formale necessari per comprendere il testo. Un punteggio tra 10-14 è considerato ideale per un pubblico vasto. Valori più alti indicano maggiore complessità.</span>
                            </span>
                    </div>
                </div>
                    
                </div>
                <div class="chart-container"><canvas id="article-chart"></canvas></div>
            {% else %}
                <p class="no-data-message">Nessun articolo trovato o processato.</p>
            {% endif %}
        </div>
        
    </div> {# FINE stats-grid per i contenuti #}

    {# --- SEZIONE 2: Scheda Log domande --- #}
    <div class="stat-card">
        <h3><i class="fas fa-question-circle fa-fw"></i> Log domande ({{ stats_data.query_logs.total_queries if stats_data.query_logs else 0 }})</h3>
        
        {% if stats_data.query_logs and stats_data.query_logs.total_queries > 0 %}
            
            {# Grafico a spezzate per le domande giornaliere #}
            <h4 style="font-size: 1rem; margin-bottom: 10px; margin-top: 0; flex-shrink: 0;">Domande negli ultimi 30 giorni</h4>
            <div class="line-chart-container">
                <canvas id="query-trend-chart"></canvas>
            </div>

            {# Contatori per fonte #}
            <div class="metrics-container" style="margin-top: var(--spacing-xl);">
                <div class="metric-item">
                    <div class="value">{{ stats_data.query_logs.source_counts.get('telegram', 0) }}</div>
                    <div class="label">da telegram</div>
                </div>

                <div class="metric-item">
                    <div class="value">{{ stats_data.query_logs.source_counts.get('widget_chat', 0) }}</div>
                    <div class="label">da widget</div>
                </div>
            </div>

            {# Lista delle domande recenti (riaggiunta qui, sotto i contatori) #}
            <h4 style="font-size: 1rem; margin-bottom: 10px; margin-top: 20px; flex-shrink: 0;">Domande più recenti:</h4>
            <ul class="recent-queries-list">
                {% for query in stats_data.query_logs.recent_queries %}
                <li>
                    <span class="query-text">{{ query.query_text | truncate(80) }}</span>
                    <span class="query-source source-{{ query.source | replace('_', '-') }}">{{ query.source | replace('_', ' ') }}</span>
                </li>
                {% endfor %}
            </ul>

        {% else %}
            <p class="no-data-message">Nessuna domanda registrata finora.</p>
        {% endif %}
    </div> {# FINE stat-card per Log Domande #}



    {% endif %} {# FINE if stats_data.error #}
{% endblock %}

{% block scripts %}
    {{ super() }}
    <!-- Includiamo la libreria Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    {# Importa l'adattatore per le date di Chart.js #}
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const dataContainer = document.getElementById('stats-data-container');
            if (!dataContainer) return;
            const statsData = JSON.parse(dataContainer.dataset.stats || '{}');

            // Funzione per creare i grafici a barre della distribuzione (invariata)
            function createDistributionChart(canvasId, data) {
                const ctx = document.getElementById(canvasId);
                if (!ctx || !data || data.length === 0) return;

                const maxVal = Math.max(...data);
                const binCount = Math.min(10, Math.ceil(maxVal / 100) || 1); 
                const binSize = Math.ceil(maxVal / binCount);
                
                const labels = [];
                const counts = [];
                if (maxVal > 0 && binSize > 0) {
                    for (let i = 0; i < maxVal; i += binSize) {
                        const rangeEnd = i + binSize;
                        labels.push(`${i}-${rangeEnd}`);
                        counts.push(data.filter(val => val >= i && val < rangeEnd).length);
                    }
                }

                new Chart(ctx, {
                    type: 'bar',
                    data: { labels: labels, datasets: [{ label: 'Numero di contenuti', data: counts, backgroundColor: 'rgba(67, 97, 238, 0.6)', borderColor: 'rgba(67, 97, 238, 1)', borderWidth: 1 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, title: { display: true, text: 'Numero di contenuti' } }, x: { title: { display: true, text: 'Fascia di lunghezza (parole)' } } } }
                });
            }

            // --- NUOVA FUNZIONE PER GRAFICO A SPEZZATE (query_logs) ---
            function createQueryTrendChart(canvasId, trendData) {
                const ctx = document.getElementById(canvasId);
                if (!ctx || !trendData || trendData.length === 0) return;

                // Prepariamo i dati per Chart.js
                // Assicurati che tutte le date degli ultimi 30 giorni siano presenti, anche quelle con 0 domande
                const allDates = [];
                const today = new Date();
                for (let i = 29; i >= 0; i--) { // Ultimi 30 giorni (0-29)
                    const d = new Date(today);
                    d.setDate(today.getDate() - i);
                    allDates.push(d.toISOString().slice(0, 10)); // Formato 'YYYY-MM-DD'
                }

                const dataMap = new Map(trendData.map(item => [item.query_date, item.query_count]));
                const dataPoints = allDates.map(date => dataMap.get(date) || 0);

                new Chart(ctx, {
                    type: 'line', 
                    data: {
                        labels: allDates, // Usiamo tutte le date generate
                        datasets: [{
                            label: 'Numero di Domande',
                            data: dataPoints,
                            fill: true, 
                            backgroundColor: 'rgba(67, 97, 238, 0.2)',
                            borderColor: 'rgba(67, 97, 238, 1)',
                            tension: 0.3, 
                            pointBackgroundColor: 'rgba(67, 97, 238, 1)',
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Numero di Domande' },
                                ticks: {
                                    stepSize: 1,
                                    callback: function(value) {if (Math.floor(value) === value) {return value;}}
                                }
                            },
                            x: {
                                type: 'time', 
                                time: {
                                    unit: 'day', 
                                    tooltipFormat: 'dd MMM yyyy', 
                                    displayFormats: {
                                        day: 'dd MMM'
                                    }
                                },
                                title: { display: true, text: 'Data' }
                            }
                        }
                    }
                });
            }
            // --- FINE NUOVA FUNZIONE ---

            // Inizializzazione dei grafici a barre (esistenti)
            if (statsData.videos && statsData.videos.count > 0) { createDistributionChart('video-chart', JSON.parse(statsData.videos.word_count_distribution_json)); }
            if (statsData.documents && statsData.documents.count > 0) { createDistributionChart('document-chart', JSON.parse(statsData.documents.word_count_distribution_json)); }
            if (statsData.articles && statsData.articles.count > 0) { createDistributionChart('article-chart', JSON.parse(statsData.articles.word_count_distribution_json)); }

            // --- CHIAMATA PER IL GRAFICO A SPEZZATE ---
            if (statsData.query_logs && statsData.query_logs.daily_query_trend) {
                createQueryTrendChart('query-trend-chart', statsData.query_logs.daily_query_trend);
            }
            // --- FINE CHIAMATA ---
            
            // Gestione del pulsante di ricalcolo (invariato)
            const recalculateForm = document.getElementById('recalculate-form');
            if (recalculateForm) {
                recalculateForm.addEventListener('submit', async (event) => {
                    event.preventDefault(); 
                    const confirmed = await window.showConfirmModal(
                        'Conferma ricalcolo',
                        'Questa operazione analizzerà tutti i tuoi contenuti esistenti per calcolare le statistiche. Potrebbe richiedere qualche istante. Sei sicuro di voler procedere?'
                    );
                    if (confirmed) {
                        const btn = document.getElementById('recalculate-stats-btn');
                        if (btn) {
                            btn.disabled = true;
                            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ricalcolo in corso...';
                        }
                        recalculateForm.submit();
                    }
                });
            }
        });
    </script>
{% endblock %}