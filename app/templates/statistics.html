<!-- FILE: app/templates/statistics.html (Versione Finale Completa) -->

{% extends "base.html" %}

{% block title %}STATistiche - Magazzino del Creatore{% endblock %}

{% block head_styles %}
<style>
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: var(--spacing-xl);
        margin-top: var(--spacing-xl);
    }
    .stat-card {
        background-color: var(--color-background-secondary);
        border: 1px solid var(--color-border);
        border-radius: var(--border-radius-md);
        padding: var(--spacing-xl);
        box-shadow: var(--box-shadow-sm);
        display: flex;
        flex-direction: column;
    }
    .stat-card h3 {
        font-family: var(--font-sans);
        font-size: 1.2rem;
        margin-top: 0;
        margin-bottom: var(--spacing-lg);
        color: var(--color-text-secondary);
        border-bottom: 1px solid var(--color-border-light);
        padding-bottom: var(--spacing-md);
    }
    .metrics-container {
        display: flex;
        justify-content: space-around;
        text-align: center;
        margin-bottom: var(--spacing-xl);
    }
    .metric-item .value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--color-primary);
    }
    .metric-item .label {
        font-size: 0.9rem;
        color: var(--color-text-light);
    }
    .chart-container {
        flex-grow: 1; /* Assicura che il grafico occupi lo spazio rimanente */
        min-height: 250px; /* Altezza minima per il grafico */
    }
    .no-data-message {
        color: var(--color-text-light);
        font-style: italic;
        text-align: center;
        margin-top: 20px;
    }
    .action-panel { 
        margin-bottom: var(--spacing-xl); 
    }
    /* Stili per il tooltip informativo */
    .info-tooltip {
        position: relative;
        display: inline-flex; /* Allinea l'icona verticalmente con il testo */
        align-items: center;
        margin-left: 5px;
        cursor: help;
    }
    .info-tooltip .fa-info-circle {
        color: var(--color-text-light);
        font-size: 0.9em;
    }
    .info-tooltip .tooltip-text {
        visibility: hidden;
        width: 260px;
        background-color: var(--color-metal-dark);
        color: #fff;
        text-align: center;
        border-radius: 6px;
        padding: 10px;
        position: absolute;
        z-index: 1;
        bottom: 135%;
        left: 50%;
        margin-left: -130px; /* Metà della larghezza */
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 0.85rem;
        font-weight: 400; /* Assicura che il testo sia normale */
        line-height: 1.5;
    }
    .info-tooltip:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
    }
    /* Freccina per il tooltip */
    .info-tooltip .tooltip-text::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: var(--color-metal-dark) transparent transparent transparent;
    
}
</style>
{% endblock %}

{% block content %}
    <h1>Le tue STATistiche</h1>
    <p>Analisi quantitative dei tuoi contenuti per aiutarti a capire meglio il tuo magazzino. I calcoli si basano solo sui contenuti che sono stati processati con successo.</p>

    <!-- Contenitore nascosto per passare i dati da Python a JavaScript in modo pulito -->
    <div id="stats-data-container" data-stats='{{ stats_data | tojson | safe }}' style="display: none;"></div>

    {# Pannello con il pulsante di Ricalcolo #}
    <div class="action-panel">
        <form action="{{ url_for('statistics.recalculate_stats') }}" method="POST" id="recalculate-form">
            <button type="submit" id="recalculate-stats-btn" class="action-btn secondary">
                <i class="fas fa-sync-alt"></i> Ricalcola statistiche per contenuti ssistenti
            </button>
        </form>
    </div>

    {# Area per mostrare messaggi di successo o errore (es. dopo il ricalcolo) #}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="{{ 'success-message' if category == 'success' else 'error-message' }}" style="margin-bottom: 20px;">
                    <span>{{ message }}</span>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    {% if stats_data.error %}
        <div class="error-message">{{ stats_data.error }}</div>
    {% else %}
    <div class="stats-grid">
        
        {# --- Scheda per i VIDEO --- #}
        <div class="stat-card">
            <h3><i class="fas fa-video fa-fw"></i> Video ({{ stats_data.videos.count }})</h3>
            {% if stats_data.videos.count > 0 %}
                <div class="metrics-container">
                    <div class="metric-item"><div class="value">{{ stats_data.videos.avg_word_count }}</div><div class="label">Parole medie</div></div>
                    <div class="metric-item"><div class="value">{{ stats_data.videos.avg_gunning_fog }}</div><div class="label">Indice leggibilità
                                                    <span class="info-tooltip">
                                <i class="fas fa-info-circle"></i>
                                <span class="tooltip-text">L'indice Gunning fog stima gli anni di istruzione formale necessari per comprendere il testo. Un punteggio tra 10-14 è considerato ideale per un pubblico vasto. Valori più alti indicano maggiore complessità.</span>
                            </span>
                    </div></div>
        </span>
                </div>
                <div class="chart-container"><canvas id="video-chart"></canvas></div>
            {% else %}
                <p class="no-data-message">Nessun video trovato o processato.</p>
            {% endif %}
        </div>

        {# --- Scheda per i DOCUMENTI --- #}
        <div class="stat-card">
            <h3><i class="fas fa-file-alt fa-fw"></i> Documenti ({{ stats_data.documents.count }})</h3>
            {% if stats_data.documents.count > 0 %}
                <div class="metrics-container">
                    <div class="metric-item"><div class="value">{{ stats_data.documents.avg_word_count }}</div><div class="label">Parole medie</div></div>
                    <div class="metric-item"><div class="value">{{ stats_data.documents.avg_gunning_fog }}</div><div class="label">Indice leggibilità
                                                    <span class="info-tooltip">
                                <i class="fas fa-info-circle"></i>
                                <span class="tooltip-text">L'indice Gunning fog stima gli anni di istruzione formale necessari per comprendere il testo. Un punteggio tra 10-14 è considerato ideale per un pubblico vasto. Valori più alti indicano maggiore complessità.</span>
                            </span>
                    </div></div>

                </div>
                <div class="chart-container"><canvas id="document-chart"></canvas></div>
            {% else %}
                <p class="no-data-message">Nessun documento trovato o processato.</p>
            {% endif %}
        </div>

        {# --- Scheda per gli ARTICOLI --- #}
        <div class="stat-card">
            <h3><i class="fas fa-newspaper fa-fw"></i> Articoli ({{ stats_data.articles.count }})</h3>
            {% if stats_data.articles.count > 0 %}
                <div class="metrics-container">
                    <div class="metric-item"><div class="value">{{ stats_data.articles.avg_word_count }}</div><div class="label">Parole medie</div></div>
                    <div class="metric-item"><div class="value">{{ stats_data.articles.avg_gunning_fog }}</div><div class="label">Indice leggibilità
                                                    <span class="info-tooltip">
                                <i class="fas fa-info-circle"></i>
                                <span class="tooltip-text">L'indice Gunning fog stima gli anni di istruzione formale necessari per comprendere il testo. Un punteggio tra 10-14 è considerato ideale per un pubblico vasto. Valori più alti indicano maggiore complessità.</span>
                            </span>
                    </div>
                </div>
                    
                </div>
                <div class="chart-container"><canvas id="article-chart"></canvas></div>
            {% else %}
                <p class="no-data-message">Nessun articolo trovato o processato.</p>
            {% endif %}
        </div>
    </div>
    {% endif %}
{% endblock %}

{% block scripts %}
    {{ super() }}
    <!-- Includiamo la libreria Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Leggiamo i dati dall'attributo data-*
            const dataContainer = document.getElementById('stats-data-container');
            const statsData = JSON.parse(dataContainer.dataset.stats || '{}');

            // Funzione per creare i grafici a barre della distribuzione
            function createDistributionChart(canvasId, label, data) {
                const ctx = document.getElementById(canvasId);
                if (!ctx || !data || data.length === 0) return;

                // Creiamo dei "contenitori" (bin) per l'istogramma
                const maxVal = Math.max(...data);
                const binSize = Math.ceil(maxVal / 10); // Dividiamo in 10 fasce
                const labels = [];
                const counts = [];
                for (let i = 0; i < maxVal; i += binSize) {
                    const rangeEnd = i + binSize;
                    labels.push(`${i}-${rangeEnd}`);
                    counts.push(data.filter(val => val >= i && val < rangeEnd).length);
                }

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Numero di Contenuti per Lunghezza',
                            data: counts,
                            backgroundColor: 'rgba(67, 97, 238, 0.6)',
                            borderColor: 'rgba(67, 97, 238, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, title: { display: true, text: 'Numero di Contenuti' } },
                            x: { title: { display: true, text: 'Fascia di Lunghezza (parole)' } }
                        }
                    }
                });
            }

            // Inizializzazione dei grafici
            if (statsData.videos && statsData.videos.count > 0) {
                createDistributionChart('video-chart', 'Video', JSON.parse(statsData.videos.word_count_distribution_json));
            }
            if (statsData.documents && statsData.documents.count > 0) {
                createDistributionChart('document-chart', 'Documenti', JSON.parse(statsData.documents.word_count_distribution_json));
            }
            if (statsData.articles && statsData.articles.count > 0) {
                createDistributionChart('article-chart', 'Articoli', JSON.parse(statsData.articles.word_count_distribution_json));
            }

            // Gestione del pulsante di ricalcolo
            const recalculateForm = document.getElementById('recalculate-form');
            if (recalculateForm) {
                recalculateForm.addEventListener('submit', async (event) => {
                    event.preventDefault(); 

                    const confirmed = await window.showConfirmModal(
                        'Conferma Ricalcolo',
                        'Questa operazione analizzerà tutti i tuoi contenuti esistenti per calcolare le statistiche. Potrebbe richiedere qualche istante. Sei sicuro di voler procedere?'
                    );

                    if (confirmed) {
                        const btn = document.getElementById('recalculate-stats-btn');
                        if (btn) {
                            btn.disabled = true;
                            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ricalcolo in corso...';
                        }
                        recalculateForm.submit();
                    }
                });
            }
        });
    </script>
{% endblock %}