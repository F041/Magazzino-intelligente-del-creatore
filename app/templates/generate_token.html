{% extends "base.html" %}

{% block title %}Genera Link di Accesso per terzi{% endblock %}

{% block head_styles %}
<style>
    .main-container { max-width: 700px; } /* Limita la larghezza per leggibilità */
    .form-section {
        background: #fff;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        border: 1px solid #dee2e6;
    }
    .form-group { margin-bottom: 20px; }
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600; /* Testo più marcato */
        color: #333;
    }
    .form-group input, .form-group select {
        width: 100%;
        padding: 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 1em;
    }
    .generated-link-area {
        margin-top: 30px;
        padding: 20px;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        display: none; /* Nascosto di default */
    }
    .generated-link-area textarea {
        width: 100%;
        font-family: monospace;
        padding: 10px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        resize: none;
        background-color: #fff;
    }
    #copy-link-btn {
        margin-top: 10px;
        background-color: #28a745; /* Verde per l'azione di copia */
    }
    #copy-link-btn:hover {
        background-color: #218838;
    }
</style>
{% endblock %}

{% block content %}
<div class="main-container">
    <h1>Accesso a terzi alla Chat</h1>
    <p style="margin-bottom: 25px; color: #555;">Crea un link sicuro e temporaneo da condividere con un utente per dargli accesso limitato alla sola interfaccia di chat.</p>

    <div class="form-section">
        <form id="generate-token-form">
            <div class="form-group">
                <label for="user_identifier">Identificativo Utente</label>
                <input type="text" id="user_identifier" name="user_id" placeholder="Es: mario.rossi@azienda.com o 'NuovoAssuntoMarketing'" required>
                <small style="color: #6c757d;">Questo serve solo a te per riconoscere chi sta usando il link.</small>
            </div>
            <div class="form-group">
                <label for="token_expiry">Durata Validità Link</label>
                <select id="token_expiry" name="expires_in">
                    <option value="3600">1 Ora</option>
                    <option value="28800">8 Ore (Giornata Lavorativa)</option>
                    <option value="86400" selected>1 Giorno</option>
                    <option value="604800">7 Giorni</option>
                </select>
            </div>
            <button type="submit" class="action-btn">Genera Link di Accesso</button>
        </form>
    </div>

    <div id="generated-link-area" class="generated-link-area">
        <h3>Link Sicuro Generato</h3>
        <p>Copia questo link e invialo all'utente. Funzionerà solo per il tempo specificato.</p>
        <textarea id="generated-link-textarea" rows="4" readonly></textarea>
        <button id="copy-link-btn" class="action-btn">Copia Link</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('generate-token-form');
    const generatedLinkArea = document.getElementById('generated-link-area');
    const linkTextarea = document.getElementById('generated-link-textarea');
    const copyBtn = document.getElementById('copy-link-btn');

    form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        submitButton.textContent = 'Generazione...';
        generatedLinkArea.style.display = 'none';

        const formData = new FormData(form);
        const data = {
            user_id: formData.get('user_id'),
            expires_in: formData.get('expires_in')
        };

        try {
            const response = await fetch('/keys/api/generate-token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(data)
            });
            const result = await response.json();

            if (response.ok && result.success) {
                // Costruisci l'URL completo del widget standalone
                const widgetUrl = new URL('/widget-standalone', window.location.origin);
                widgetUrl.searchParams.append('token', result.token);
                
                linkTextarea.value = widgetUrl.href;
                generatedLinkArea.style.display = 'block';
                
            } else {
                throw new Error(result.message || 'Errore sconosciuto dal server.');
            }
        } catch (error) {
            alert(`Errore: ${error.message}`);
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = 'Genera Link di Accesso';
        }
    });

    copyBtn.addEventListener('click', () => {
        linkTextarea.select();
        navigator.clipboard.writeText(linkTextarea.value).then(() => {
            copyBtn.textContent = 'Copiato!';
            setTimeout(() => { copyBtn.textContent = 'Copia Link'; }, 2000);
        }).catch(err => {
            alert('Errore nella copia automatica. Copia manualmente per favore.');
        });
    });
});
</script>
{% endblock %}