{% extends "base.html" %}

{% block title %}I tuoi articoli - Magazzino del Creatore{% endblock %}

{% block content %}
    <h1>I tuoi articoli da Feed RSS ({{ articles|length }})</h1>
    
    <div class="action-panel">
        <a href="{{ url_for('rss.download_all_articles') }}" class="action-btn success-btn">
            <i class="fas fa-download fa-fw"></i>
            <span>Scarica contenuto articoli (.txt) </span>
        </a>
        <span style="font-size: 0.9em; color: var(--color-text-light);">(Solo articoli 'completed')</span>
        {% if config.APP_MODE == 'saas' %}
            <button id="delete-all-articles-btn" class="action-btn delete-btn" style="margin-left: auto;">
                <i class="fas fa-trash-alt fa-fw"></i>
                <span>Elimina tutti</span>
            </button>
            <!-- CORREZIONE: Loader nascosto di default -->
            <span id="delete-all-articles-loader" class="action-loader" style="display: none;">(eliminazione...)</span>
        {% endif %}
    </div>
    
    <div id="action-message"></div>

    <div id="articles-container" class="table-responsive-wrapper">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Titolo</th>
                    <th>Data Pubblicazione</th>
                    <th>Data Aggiunta</th>
                    <th>Stato</th>
                    <th>Anteprima Contenuto</th>
                    <th>Azioni</th>
                </tr>
            </thead>
            <tbody>
                {% for article in articles %}
                <tr id="article-row-{{ article.article_id | escape }}">
                    <td><a href="{{ article.article_url }}" target="_blank" title="{{ article.article_url }}">{{ article.title }}</a></td>
                    <td>{{ (article.published_at | format_date('%d %b %Y')) if article.published_at else 'N/D' }}</td>
                    <td>{{ article.added_at | format_date('%d %b %Y') }}</td>
                    <td>
                        <span class="status-badge status-{{ article.processing_status | lower | replace('_', '-') }}">{{ article.processing_status }}</span>
                    </td>
                    <td>
                        {% if article.content_preview %}
                            <p style="font-size: 0.9em; color: var(--color-text-secondary); margin: 0;">
                                {{ article.content_preview | striptags | escape }}
                                {% if article.content_preview|length >= 200 %}...{% endif %}
                            </p>
                        {% else %}
                            <span style="color: var(--color-text-light); font-style: italic;">Nessuna</span>
                        {% endif %}
                    </td>
                    <td>                        
                        {# Placeholder per future azioni come "Elimina Singolo" #}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="no-items-message">
                        Nessun articolo trovato nel database.<br>
                        Vai su <a href="{{ url_for('data_entry') }}">Ingresso Dati</a> per processare un feed RSS.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const deleteAllBtn = document.getElementById('delete-all-articles-btn');
    const deleteAllLoader = document.getElementById('delete-all-articles-loader');
    const articlesTbody = document.querySelector('#articles-container tbody');

    function showNotification(message, type = "success") {
        const messageDiv = document.getElementById('action-message');
        if (!messageDiv) return;
        messageDiv.className = type === "success" ? "success-message" : "error-message";
        messageDiv.textContent = message;
        messageDiv.style.opacity = "0";
        messageDiv.style.display = "flex";
        setTimeout(() => { messageDiv.style.opacity = "1"; }, 10);
        setTimeout(() => {
            messageDiv.style.opacity = "0";
            setTimeout(() => { messageDiv.style.display = "none"; }, 500);
        }, 5000);
    }

    if (deleteAllBtn) {
        if (deleteAllLoader) {
            deleteAllLoader.style.display = 'none';
        }

        deleteAllBtn.addEventListener('click', async () => {
            const userConfirmed = await showConfirmModal(
                "Conferma eliminazione",
                "ATTENZIONE! Sei sicuro di voler eliminare TUTTI gli articoli? L'azione Ã¨ irreversibile."
            );
            if (!userConfirmed) return;

            const originalHTML = deleteAllBtn.innerHTML;
            deleteAllBtn.disabled = true;
            deleteAllBtn.textContent = 'Eliminazione...';
            if (deleteAllLoader) deleteAllLoader.style.display = 'inline';

            try {
                const response = await fetch('/api/rss/all', {
                    method: 'DELETE',
                    headers: { 'Accept': 'application/json' }
                });
                const data = await response.json();

                if (response.ok && data.success) {
                    showNotification(data.message || "Eliminazione completata.", 'success');
                    if (articlesTbody) {
                        articlesTbody.innerHTML = `<tr><td colspan="6" class="no-items-message">Nessun articolo da mostrare.</td></tr>`;
                    }
                    deleteAllBtn.textContent = 'Eliminati';
                } else {
                    throw new Error(data.message || 'Errore durante l\'eliminazione');
                }
            } catch (error) {
                showNotification(error.message, 'error');
                deleteAllBtn.disabled = false;
                deleteAllBtn.innerHTML = originalHTML;
            } finally {
                if (deleteAllLoader) deleteAllLoader.style.display = 'none';
            }
        });

        const isTableEmpty = !articlesTbody || !articlesTbody.querySelector('tr:not(:has(.no-items-message))');
        if (isTableEmpty) {
            deleteAllBtn.disabled = true;
        }
    }
});
</script>
{% endblock %}